<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="spmodel">
<title>A Detailed Guide to spmodel • spmodel</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="A Detailed Guide to spmodel">
<meta property="og:description" content="spmodel">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">spmodel</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/guide.html">A Detailed Guide to spmodel</a>
    <a class="dropdown-item" href="../articles/SPGLMs.html">Spatial Generalized Linear Models in spmodel</a>
    <a class="dropdown-item" href="../articles/technical.html">Technical Details</a>
    <a class="dropdown-item" href="../articles/introduction.html">An Introduction to spmodel</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/USEPA/spmodel/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>A Detailed Guide to spmodel</h1>
                        <h4 data-toc-skip class="author">Michael
Dumelle, Matt Higham, and Jay M. Ver Hoef</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/USEPA/spmodel/blob/HEAD/vignettes/articles/guide.Rmd" class="external-link"><code>vignettes/articles/guide.Rmd</code></a></small>
      <div class="d-none name"><code>guide.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="sec:introduction">Introduction<a class="anchor" aria-label="anchor" href="#sec:introduction"></a>
</h2>
<p><code>spmodel</code> is an package used to fit, summarize, and
predict for a variety of spatial statistical models. The vignette
provides an introduction to both the basic and advanced features of the
<code>spmodel</code> package coupled with a brief theoretical
explanation of the methods. First we give a brief theoretical
introduction to spatial linear models. Then we outline the variety of
methods used to estimate the parameters of spatial linear models. Then
we explain how to obtain predictions at unobserved locations. Then we
detail some advanced modeling features, including random effects,
partition factors, anisotropy, big data approaches, and spatial
generalized linear models. Finally we end with a short discussion.
Before proceeding, we load <code>spmodel</code> by running</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://usepa.github.io/spmodel/" class="external-link">spmodel</a></span><span class="op">)</span></span></code></pre></div>
<p>If using <code>spmodel</code> in a formal publication or report,
please cite it. Citing <code>spmodel</code> lets us devote more
resources to the package in the future. We view the <code>spmodel</code>
citation by running</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/citation.html" class="external-link">citation</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"spmodel"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; To cite spmodel in publications use:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Dumelle M, Higham M, Ver Hoef JM (2023). spmodel: Spatial statistical</span></span>
<span><span class="co">#&gt;   modeling and prediction in R. PLOS ONE 18(3): e0282524.</span></span>
<span><span class="co">#&gt;   https://doi.org/10.1371/journal.pone.0282524</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A BibTeX entry for LaTeX users is</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   @Article{,</span></span>
<span><span class="co">#&gt;     title = {{spmodel}: Spatial statistical modeling and prediction in {R}},</span></span>
<span><span class="co">#&gt;     author = {Michael Dumelle and Matt Higham and Jay M. {Ver Hoef}},</span></span>
<span><span class="co">#&gt;     journal = {PLOS ONE},</span></span>
<span><span class="co">#&gt;     year = {2023},</span></span>
<span><span class="co">#&gt;     volume = {18},</span></span>
<span><span class="co">#&gt;     number = {3},</span></span>
<span><span class="co">#&gt;     pages = {1--32},</span></span>
<span><span class="co">#&gt;     doi = {10.1371/journal.pone.0282524},</span></span>
<span><span class="co">#&gt;     url = {https://doi.org/10.1371/journal.pone.0282524},</span></span>
<span><span class="co">#&gt;   }</span></span></code></pre>
<p>We will create visualizations using <code>ggplot2</code> <span class="citation">(Wickham 2016)</span>, which we load by running</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p><code>ggplot2</code> is only installed alongside <code>spmodel</code>
when <code>dependencies = TRUE</code> in
<code><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages()</a></code>, so check that the package is installed
and loaded before reproducing any of these vignette’s visualizations. We
will also show code that can be used to create interactive
visualizations of spatial data with <code>mapview</code> <span class="citation">(Appelhans et al. 2022)</span>. <code>mapview</code>
also has many backgrounds available that contextualize spatial data with
topographical information. Before running the <code>mapview</code> code
interactively, make sure <code>mapview</code> is installed and
loaded.</p>
<p><code>spmodel</code> contains various methods for generic functions
defined outside of <code>spmodel</code>. To find relevant documentation
for these methods, run <code>help("generic.spmodel", "spmodel")</code>
(e.g., <code><a href="../reference/summary.spmodel.html">help("summary.spmodel", "spmodel")</a></code>,
<code><a href="../reference/predict.spmodel.html">help("predict.spmodel", "spmodel")</a></code>, etc.). Note that
<code>?generic.spmodel</code> is shorthand for
<code>help("generic.spmodel", "spmodel")</code>. We provide more details
and examples regarding these methods and generics throughout this
vignette. For a full list of <code>spmodel</code> functions available,
see <code>spmodel</code>’s documentation manual.</p>
</div>
<div class="section level2">
<h2 id="sec:theomodel">The Spatial Linear Model<a class="anchor" aria-label="anchor" href="#sec:theomodel"></a>
</h2>
<p>Statistical linear models are often parameterized as <span class="math display">\[
\mathbf{y} = \mathbf{X} \boldsymbol{\beta} + \boldsymbol{\epsilon},
\]</span> where for a sample size <span class="math inline">\(n\)</span>, <span class="math inline">\(\mathbf{y}\)</span> is an <span class="math inline">\(n \times 1\)</span> column vector of response
variables, <span class="math inline">\(\mathbf{X}\)</span> is an <span class="math inline">\(n \times p\)</span> design (model) matrix of
explanatory variables, <span class="math inline">\(\boldsymbol{\beta}\)</span> is a <span class="math inline">\(p \times 1\)</span> column vector of fixed effects
controlling the impact of <span class="math inline">\(\mathbf{X}\)</span> on <span class="math inline">\(\mathbf{y}\)</span>, and <span class="math inline">\(\boldsymbol{\epsilon}\)</span> is an <span class="math inline">\(n \times 1\)</span> column vector of random
errors. We typically assume that <span class="math inline">\(\text{E}(\boldsymbol{\epsilon}) =
\mathbf{0}\)</span> and <span class="math inline">\(\text{Cov}(\boldsymbol{\epsilon}) =
\sigma^2_\epsilon \mathbf{I}\)</span>, where <span class="math inline">\(\text{E}(\cdot)\)</span> denotes expectation,
<span class="math inline">\(\text{Cov}(\cdot)\)</span> denotes
covariance, <span class="math inline">\(\sigma^2_\epsilon\)</span>
denotes a variance parameter, and <span class="math inline">\(\mathbf{I}\)</span> denotes the identity
matrix.</p>
<p>The model <span class="math inline">\(\mathbf{y} = \mathbf{X}
\boldsymbol{\beta} + \boldsymbol{\epsilon}\)</span> assumes the elements
of <span class="math inline">\(\mathbf{y}\)</span> are uncorrelated.
Typically for spatial data, elements of <span class="math inline">\(\mathbf{y}\)</span> are correlated, as
observations close together in space tend to be more similar than
observations far apart <span class="citation">(Tobler 1970)</span>.
Failing to properly accommodate the spatial dependence in <span class="math inline">\(\mathbf{y}\)</span> can cause researchers to draw
incorrect conclusions about their data. To accommodate spatial
dependence in <span class="math inline">\(\mathbf{y}\)</span>, an <span class="math inline">\(n \times 1\)</span> spatial random effect, <span class="math inline">\(\boldsymbol{\tau}\)</span>, is added to the linear
model, yielding the model <span class="math display">\[
\mathbf{y} = \mathbf{X} \boldsymbol{\beta} + \boldsymbol{\tau} +
\boldsymbol{\epsilon},
\]</span> where <span class="math inline">\(\boldsymbol{\tau}\)</span>
is independent of <span class="math inline">\(\boldsymbol{\epsilon}\)</span>, <span class="math inline">\(\text{E}(\boldsymbol{\tau}) = \mathbf{0}\)</span>,
<span class="math inline">\(\text{Cov}(\boldsymbol{\tau}) =
\sigma^2_\tau \mathbf{R}\)</span>, <span class="math inline">\(\mathbf{R}\)</span> is a matrix that determines
the spatial dependence structure in <span class="math inline">\(\mathbf{y}\)</span> and depends on a range
parameter, <span class="math inline">\(\phi\)</span>. We discuss <span class="math inline">\(\mathbf{R}\)</span> in more detail shortly. The
parameter <span class="math inline">\(\sigma^2_\tau\)</span> is called
the spatially dependent random error variance or partial sill. The
parameter <span class="math inline">\(\sigma^2_\epsilon\)</span> is
called the spatially independent random error variance or nugget. These
two variance parameters are henceforth more intuitively written as <span class="math inline">\(\sigma^2_{de}\)</span> and <span class="math inline">\(\sigma^2_{ie}\)</span>, respectively. The
covariance of <span class="math inline">\(\mathbf{y}\)</span> is denoted
<span class="math inline">\(\boldsymbol{\Sigma}\)</span> and given by
<span class="math inline">\(\sigma^2_{de} \mathbf{R} + \sigma^2_{ie}
\mathbf{I}\)</span>. The parameters that compose this covariance are
contained in the vector <span class="math inline">\(\boldsymbol{\theta}\)</span>, which is called the
covariance parameter vector.</p>
<p>The model <span class="math inline">\(\mathbf{y} = \mathbf{X}
\boldsymbol{\beta} + \boldsymbol{\tau} + \boldsymbol{\epsilon}\)</span>
is called the spatial linear model. The spatial linear model applies to
both point-referenced and areal (i.e., lattice) data. Spatial data are
point-referenced when the elements in <span class="math inline">\(\mathbf{y}\)</span> are observed at
point-locations indexed by x-coordinates and y-coordinates on a
spatially continuous surface with an infinite number of locations. The
<code><a href="../reference/splm.html">splm()</a></code> function is used to fit spatial linear models for
point-referenced data (these are sometimes called geostatistical
models). One spatial covariance function available in
<code><a href="../reference/splm.html">splm()</a></code> is the exponential spatial covariance function,
which has an <span class="math inline">\(\mathbf{R}\)</span> matrix
given by <span class="math display">\[
\mathbf{R} = \exp(-\mathbf{M} / \phi),
\]</span> where <span class="math inline">\(\mathbf{M}\)</span> is a
matrix of Euclidean distances among observations. Recall that <span class="math inline">\(\phi\)</span> is the range parameter, controlling
the behavior of of the covariance function as a function of distance.
Parameterizations for <code><a href="../reference/splm.html">splm()</a></code> spatial covariance types and
their <span class="math inline">\(\mathbf{R}\)</span> matrices can be
seen by running <code><a href="../reference/splm.html">help("splm", "spmodel")</a></code> or
<code><a href="../articles/technical.html">vignette("technical", "spmodel")</a></code>. Some of these spatial
covariance types (e.g., Matérn) depend on an extra parameter beyond
<span class="math inline">\(\sigma^2_{de}\)</span>, <span class="math inline">\(\sigma^2_{ie}\)</span>, and <span class="math inline">\(\phi\)</span>.</p>
<p>Spatial data are areal when the elements in <span class="math inline">\(\mathbf{y}\)</span> are observed as part of a
finite network of polygons whose connections are indexed by a
neighborhood structure. For example, the polygons may represent counties
in a state that are neighbors if they share at least one boundary. Areal
data are often equivalently called lattice data <span class="citation">(Cressie 1993)</span>. The <code><a href="../reference/spautor.html">spautor()</a></code>
function is used to fit spatial linear models for areal data (these are
sometimes called spatial autoregressive models). One spatial
autoregressive covariance function available in <code><a href="../reference/spautor.html">spautor()</a></code>
is the simultaneous autoregressive spatial covariance function, which
has an <span class="math inline">\(\mathbf{R}\)</span> matrix given by
<span class="math display">\[
\mathbf{R} = [(\mathbf{I} - \phi \mathbf{W})(\mathbf{I} - \phi
\mathbf{W})^\top]^{-1},
\]</span> where <span class="math inline">\(\mathbf{W}\)</span> is a
weight matrix describing the neighborhood structure in <span class="math inline">\(\mathbf{y}\)</span>. Parameterizations for
<code><a href="../reference/spautor.html">spautor()</a></code> spatial covariance types and their <span class="math inline">\(\mathbf{R}\)</span> matrices can be seen by
running <code><a href="../reference/spautor.html">help("spautor", "spmodel")</a></code> or
<code><a href="../articles/technical.html">vignette("technical", "spmodel")</a></code>.</p>
<p>One way to define <span class="math inline">\(\mathbf{W}\)</span> is
through queen contiguity <span class="citation">(Anselin, Syabri, and
Kho 2010)</span>. Two observations are queen contiguous if they share a
boundary. The <span class="math inline">\(ij\)</span>th element of <span class="math inline">\(\mathbf{W}\)</span> is then one if observation
<span class="math inline">\(i\)</span> and observation <span class="math inline">\(j\)</span> are queen contiguous and zero
otherwise. Observations are not considered neighbors with themselves, so
each diagonal element of <span class="math inline">\(\mathbf{W}\)</span>
is zero.</p>
<p>Sometimes each element in the weight matrix <span class="math inline">\(\mathbf{W}\)</span> is divided by its respective
row sum. This is called row-standardization. Row-standardizing <span class="math inline">\(\mathbf{W}\)</span> has several benefits, which
are discussed in detail by <span class="citation">Ver Hoef et al.
(2018)</span>.</p>
</div>
<div class="section level2">
<h2 id="sec:modelfit">Model Fitting<a class="anchor" aria-label="anchor" href="#sec:modelfit"></a>
</h2>
<p>In this section, we show how to use the <code><a href="../reference/splm.html">splm()</a></code> and
<code><a href="../reference/spautor.html">spautor()</a></code> functions to estimate parameters of the spatial
linear model. We also explore diagnostic tools in <code>spmodel</code>
that evaluate model fit. The <code><a href="../reference/splm.html">splm()</a></code> and
<code><a href="../reference/spautor.html">spautor()</a></code> functions share similar syntactic structure with
the <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> function used to fit linear models without spatial
dependence. <code><a href="../reference/splm.html">splm()</a></code> and <code><a href="../reference/spautor.html">spautor()</a></code> generally
require at least three arguments:</p>
<ul>
<li>
<code>formula</code>: a formula that describes the relationship
between the response variable (<span class="math inline">\(\mathbf{y}\)</span>) and explanatory variables
(<span class="math inline">\(\mathbf{X}\)</span>)</li>
<li>
<code>formula</code> in <code><a href="../reference/splm.html">splm()</a></code> is the same as
<code>formula</code> in <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>
</li>
<li>
<code>data</code>: a <code>data.frame</code> or <code>sf</code>
object that contains the response variable, explanatory variables, and
spatial information</li>
<li>
<code>spcov_type</code>: the spatial covariance type
(<code>"exponential"</code>, <code>"matern"</code>, <code>"car"</code>,
etc)</li>
</ul>
<p>If <code>data</code> is an <code>sf</code> <span class="citation">(Pebesma 2018)</span> object, spatial information is
stored in the object’s geometry. If <code>data</code> is a
<code>data.frame</code>, then the x-coordinates and y-coordinates must
be provided via the <code>xcoord</code> and <code>ycoord</code>
arguments (for point-referenced data) or the weight matrix must be
provided via the <code>W</code> argument (for areal data). The appendix
uses the <code>caribou</code> data, a <code>tibble</code> (a special
<code>data.frame</code>), to show how to provide spatial information via
<code>xcoord</code> and <code>ycoord</code> (in <code><a href="../reference/splm.html">splm()</a></code>) or
<code>W</code> (in <code><a href="../reference/spautor.html">spautor()</a></code>).</p>
<p>In the following subsections, we use the point-referenced
<code>moss</code> data, an <code>sf</code> object that contains data on
heavy metals in mosses near a mining road in Alaska. We view the first
few rows of <code>moss</code> by running</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">moss</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Simple feature collection with 365 features and 7 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -445884.1 ymin: 1929616 xmax: -383656.8 ymax: 2061414</span></span>
<span><span class="co">#&gt; Projected CRS: NAD83 / Alaska Albers</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 365 × 8</span></span></span>
<span><span class="co">#&gt;    sample field_dup lab_rep year  sideroad log_dist2road log_Zn</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 001PR  1         1       2001  N                 2.68   7.33</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 001PR  1         2       2001  N                 2.68   7.38</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 002PR  1         1       2001  N                 2.54   7.58</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 003PR  1         1       2001  N                 2.97   7.63</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 004PR  1         1       2001  N                 2.72   7.26</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 005PR  1         1       2001  N                 2.76   7.65</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 006PR  1         1       2001  S                 2.30   7.59</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 007PR  1         1       2001  N                 2.78   7.16</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 008PR  1         1       2001  N                 2.93   7.19</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 009PR  1         1       2001  N                 2.79   8.07</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 355 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: geometry &lt;POINT [m]&gt;</span></span></span></code></pre>
<p>We can learn more about <code>moss</code> by running
<code><a href="../reference/moss.html">help("moss", "spmodel")</a></code>, and we can visualize the
distribution of log zinc concentration in <code>moss</code> by
running</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">moss</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">log_Zn</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_gray</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="guide_files/figure-html/log_zn-1.png" alt="Distribution of log zinc concentration in the moss data." width="65%"><p class="caption">
Distribution of log zinc concentration in the moss data.
</p>
</div>
<p>Log zinc concentration can be viewed interactively in
<code>mapview</code> by running</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mapview</span><span class="op">(</span><span class="va">moss</span>, zcol <span class="op">=</span> <span class="st">"log_Zn"</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="estimation">Estimation<a class="anchor" aria-label="anchor" href="#estimation"></a>
</h3>
<p>Generally the covariance parameters (<span class="math inline">\(\boldsymbol{\theta}\)</span>) and fixed effects
(<span class="math inline">\(\boldsymbol{\beta}\)</span>) of the spatial
linear model require estimation. The default estimation method in
<code>spmodel</code> is restricted maximum likelihood <span class="citation">(Patterson and Thompson 1971; Harville 1977; Wolfinger,
Tobias, and Sall 1994)</span>, but the estimation method can be changed
with the <code>estmethod</code> argument to <code><a href="../reference/splm.html">splm()</a></code> or
<code><a href="../reference/spautor.html">spautor()</a></code>. Maximum likelihood estimation is also available.
For point-referenced data, semivariogram weighted least squares <span class="citation">(Cressie 1985)</span> and semivariogram composite
likelihood <span class="citation">(Curriero and Lele 1999)</span> are
additional estimation methods. The estimation method is chosen using the
<code>estmethod</code> argument.</p>
<p>We estimate parameters of a spatial linear model regressing log zinc
concentration (<code>log_Zn</code>) on log distance to a haul road
(<code>log_dist2road</code>) using an exponential spatial covariance
function by running</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/splm.html">splm</a></span><span class="op">(</span><span class="va">log_Zn</span> <span class="op">~</span> <span class="va">log_dist2road</span>, <span class="va">moss</span>, spcov_type <span class="op">=</span> <span class="st">"exponential"</span><span class="op">)</span></span></code></pre></div>
<p>We summarize the model fit by running</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">spmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; splm(formula = log_Zn ~ log_dist2road, data = moss, spcov_type = "exponential")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -2.6801 -1.3606 -0.8103 -0.2485  1.1298 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients (fixed):</span></span>
<span><span class="co">#&gt;               Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; (Intercept)    9.76825    0.25216   38.74   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; log_dist2road -0.56287    0.02013  -27.96   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Pseudo R-squared: 0.683</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients (exponential spatial covariance):</span></span>
<span><span class="co">#&gt;        de        ie     range </span></span>
<span><span class="co">#&gt; 3.595e-01 7.897e-02 8.237e+03</span></span></code></pre>
<p>The fixed effects coefficient table contains estimates, standard
errors, z-statistics, and asymptotic p-values for each fixed effect.
From this table, we notice there is evidence that mean log zinc
concentration significantly decreases with distance from the haul road
(p-value &lt; 2e-16). We see the fixed effect estimates by running</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">spmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;   (Intercept) log_dist2road </span></span>
<span><span class="co">#&gt;     9.7682525    -0.5628713</span></span></code></pre>
<p>The model summary also contains the exponential spatial covariance
parameter estimates, which we can view by running</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">spmod</span>, type <span class="op">=</span> <span class="st">"spcov"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;           de           ie        range       rotate        scale </span></span>
<span><span class="co">#&gt; 3.595316e-01 7.896824e-02 8.236712e+03 0.000000e+00 1.000000e+00 </span></span>
<span><span class="co">#&gt; attr(,"class")</span></span>
<span><span class="co">#&gt; [1] "exponential"</span></span></code></pre>
<p>The dependent random error variance (<span class="math inline">\(\sigma^2_{de}\)</span>) is estimated to be
approximately 0.36 and the independent random error variance (<span class="math inline">\(\sigma^2_{ie}\)</span>) is estimated to be
approximately 0.079. The range (<span class="math inline">\(\phi\)</span>) is estimated to be approximately
8,237. The effective range is the distance at which the spatial
covariance is approximately zero. For the exponential covariance, the
effective range is <span class="math inline">\(3\phi\)</span>. This
means that observations whose distance is greater than 24,711 meters are
approximately uncorrelated. The <code>rotate</code> and
<code>scale</code> parameters affect the modeling of anisotropy. By
default, they are assumed to be zero and one, respectively, which means
that anisotropy is not modeled (i.e., the spatial covariance is assumed
isotropic, or independent of direction). We plot the fitted spatial
covariance function by running</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">spmod</span>, which <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="guide_files/figure-html/emp_spcov-1.png" alt="Empirical spatial covariance of fitted model." width="75%"><p class="caption">
Empirical spatial covariance of fitted model.
</p>
</div>
<p>We can learn more about the plots available for fitted models by
running <code><a href="../reference/plot.spmodel.html">help("plot.splm", "spmodel")</a></code>.</p>
</div>
<div class="section level3">
<h3 id="model-fit-statistics">Model-Fit Statistics<a class="anchor" aria-label="anchor" href="#model-fit-statistics"></a>
</h3>
<p>The quality of model fit can be assessed using a variety of
statistics readily available in <code>spmodel</code>. The first
model-fit statistic we consider is the pseudo R-squared. The pseudo
R-squared is a generalization of the classical R-squared from
non-spatial linear models that quantifies the proportion of variability
in the data explained by the fixed effects. The pseudo R-squared is
defined as <span class="math display">\[
PR2 = 1 -
\frac{\mathcal{D}(\boldsymbol{\hat{\Theta}})}{\mathcal{D}(\boldsymbol{\hat{\Theta}}_0)},
\]</span> where <span class="math inline">\(\mathcal{D}(\boldsymbol{\hat{\Theta}})\)</span> is
the deviance of the fitted model indexed by parameter vector <span class="math inline">\(\boldsymbol{\hat{\Theta}}\)</span> and <span class="math inline">\(\mathcal{D}(\boldsymbol{\hat{\Theta}}_0)\)</span>
is the deviance of an intercept-only model indexed by parameter vector
<span class="math inline">\(\boldsymbol{\hat{\Theta}}_0\)</span>. For
maximum likelihood, <span class="math inline">\(\hat{\boldsymbol{\Theta}} =
\{\hat{\boldsymbol{\theta}}, \hat{\boldsymbol{\beta}}\}\)</span>. For
restricted maximum likelihood <span class="math inline">\(\hat{\boldsymbol{\Theta}} =
\{\hat{\boldsymbol{\theta}}\}\)</span>.</p>
<p>We compute the pseudo R-squared by running We compute the pseudo
R-squared by running</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pseudoR2.html">pseudoR2</a></span><span class="op">(</span><span class="va">spmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 0.6829687</span></span></code></pre>
<p>Roughly 68% of the variability in log zinc is explained by log
distance from the road. The pseudo R-squared can be adjusted to account
for the number of explanatory variables using the <code>adjust</code>
argument. Pseudo R-squared (and the adjusted version) is most helpful
for comparing models that have the same covariance structure.</p>
<p>The next two model-fit statistics we consider are the AIC and AICc.
The AIC and AICc evaluate the fit of a model with a penalty for the
number of parameters estimated. This penalty balances model fit and
model parsimony. Lower AIC and AICc indicate a better balance of model
fit and parsimony. The AICc is a correction to AIC for small sample
sizes. As the sample size increases, AIC and AICc converge.</p>
<p>The spatial AIC and AICc are given by <span class="math display">\[
  \begin{split}
    \text{AIC} &amp; = -2\ell(\hat{\boldsymbol{\Theta}}) +
2(|\hat{\boldsymbol{\Theta}}|) \\
    \text{AICc} &amp; = -2\ell(\hat{\boldsymbol{\Theta}}) +
2n(|\hat{\boldsymbol{\Theta}}|) / (n - |\hat{\boldsymbol{\Theta}}| - 1),
  \end{split}
\]</span> where <span class="math inline">\(\ell(\hat{\boldsymbol{\Theta}})\)</span> is the
log-likelihood of the data evaluated at the estimated parameter vector
<span class="math inline">\(\hat{\boldsymbol{\Theta}}\)</span> that
maximized <span class="math inline">\(\ell(\boldsymbol{\Theta})\)</span>, <span class="math inline">\(|\hat{\boldsymbol{\Theta}}|\)</span> is the
dimension of <span class="math inline">\(\hat{\boldsymbol{\Theta}}\)</span>, and <span class="math inline">\(n\)</span> is the sample size. As with the
deviance, for maximum likelihood, <span class="math inline">\(\hat{\boldsymbol{\Theta}} =
\{\hat{\boldsymbol{\theta}}, \hat{\boldsymbol{\beta}}\}\)</span>, and
for restricted maximum likelihood <span class="math inline">\(\hat{\boldsymbol{\Theta}} =
\{\hat{\boldsymbol{\theta}}\}\)</span>. There are some nuances to
consider when comparing AIC across models: AIC comparisons between a
model fit using restricted maximum likelihood and a model fit using
maximum likelihood are meaningless, as the models are fit with different
likelihoods; AIC comparisons between models fit using restricted maximum
likelihood are only valid when the models have the same fixed effect
structure; AIC comparisons between models fit using maximum likelihood
are valid even when the models have different fixed effect structures
<span class="citation">(Pinheiro and Bates 2006)</span>.</p>
<p>Suppose we want to quantify the difference in model quality between
the spatial model and a non-spatial model using the AIC and AICc
criteria. We fit a non-spatial model in <code>spmodel</code> by
running</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/splm.html">splm</a></span><span class="op">(</span><span class="va">log_Zn</span> <span class="op">~</span> <span class="va">log_dist2road</span>, <span class="va">moss</span>, spcov_type <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p>This model is equivalent to one fit using <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>. We
compute the spatial AIC and AICc of the spatial model and non-spatial
model by running</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">spmod</span>, <span class="va">lmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;       df      AIC</span></span>
<span><span class="co">#&gt; spmod  3 373.2089</span></span>
<span><span class="co">#&gt; lmod   1 636.0635</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/AIC.spmodel.html">AICc</a></span><span class="op">(</span><span class="va">spmod</span>, <span class="va">lmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;       df     AICc</span></span>
<span><span class="co">#&gt; spmod  3 373.2754</span></span>
<span><span class="co">#&gt; lmod   1 636.0745</span></span></code></pre>
<p>The noticeably lower AIC and AICc of the spatial model indicate that
it is a better fit to the data than the non-spatial model. Recall that
these AIC and AICc comparisons are valid because both models are fit
using restricted maximum likelihood (the default).</p>
<p>Another approach to comparing the fitted models is to perform
leave-one-out cross validation <span class="citation">(Hastie et al.
2009)</span>. In leave-one-out cross validation, a single observation is
removed from the data, the model is re-fit, and a prediction is made for
the held-out observation. Then, a loss metric like
mean-squared-prediction error is computed and used to evaluate model
fit. The lower the mean-squared-prediction error, the better the model
fit. For computational efficiency, leave-one-out cross validation in
<code>spmodel</code> is performed by first estimating <span class="math inline">\(\boldsymbol{\theta}\)</span> using all the data
and then re-estimating only <span class="math inline">\(\boldsymbol{\beta}\)</span> as we predict each
removed observation. We perform leave-one-out cross validation for the
spatial and non-spatial model by running</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/loocv.html">loocv</a></span><span class="op">(</span><span class="va">spmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 4</span></span></span>
<span><span class="co">#&gt;      bias  MSPE RMSPE  cor2</span></span>
<span><span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 0.006<span style="text-decoration: underline;">55</span> 0.111 0.333 0.886</span></span></code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/loocv.html">loocv</a></span><span class="op">(</span><span class="va">lmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 4</span></span></span>
<span><span class="co">#&gt;       bias  MSPE RMSPE  cor2</span></span>
<span><span class="co">#&gt;      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 0.000<span style="text-decoration: underline;">644</span> 0.324 0.569 0.667</span></span></code></pre>
<p>The noticeably lower mean-squared-prediction error of the spatial
model indicates that it is a better fit to the data than the non-spatial
model.</p>
</div>
<div class="section level3">
<h3 id="diagnostics">Diagnostics<a class="anchor" aria-label="anchor" href="#diagnostics"></a>
</h3>
<p>In addition to model fit metrics, <code>spmodel</code> provides
functions that compute diagnostic metrics that help assess model
assumptions and identify unusual observations.</p>
<p>An observation is said to have high leverage if its combination of
explanatory variable values is far from the mean vector of the
explanatory variables. For a non-spatial model, the leverage of the
<span class="math inline">\(i\)</span>th observation is the <span class="math inline">\(i\)</span>th diagonal element of the hat matrix
given by <span class="math display">\[
  \mathbf{H} = \mathbf{X}(\mathbf{X}^\top\mathbf{X})^{-1}\mathbf{X}^\top
.
\]</span></p>
<p>For a spatial model, the leverage of the <span class="math inline">\(i\)</span>th observation is the <span class="math inline">\(i\)</span>th diagonal element of the spatial hat
matrix given by <span class="math display">\[
  \mathbf{H}^* = (\mathbf{X}^* (\mathbf{X}^{* \top} \mathbf{X})^{-1}
\mathbf{X}^{* \top}) ,
\]</span> where <span class="math inline">\(\mathbf{X}^* =
\boldsymbol{\Sigma}^{-1/2}\mathbf{X}\)</span> and <span class="math inline">\(\boldsymbol{\Sigma}^{-1/2}\)</span> is the inverse
square root of the covariance matrix, <span class="math inline">\(\boldsymbol{\Sigma}\)</span> <span class="citation">(Montgomery, Peck, and Vining 2021)</span>. The spatial
hat matrix can be viewed as the non-spatial hat matrix applied to <span class="math inline">\(\mathbf{X}^*\)</span> instead of <span class="math inline">\(\mathbf{X}\)</span>. We compute the hat values
(leverage) by running</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/influence.measures.html" class="external-link">hatvalues</a></span><span class="op">(</span><span class="va">spmod</span><span class="op">)</span></span></code></pre></div>
<p>Larger hat values indicate more leverage, and observations with large
hat values may be unusual and warrant further investigation.</p>
<p>The fitted value of an observation is the estimated mean response
given the observation’s explanatory variable values and the model fit:
<span class="math display">\[
\hat{\mathbf{y}} = \mathbf{X} \hat{\boldsymbol{\beta}}.
\]</span> We compute the fitted values by running</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">spmod</span><span class="op">)</span></span></code></pre></div>
<p>Fitted values for the spatially dependent random errors (<span class="math inline">\(\boldsymbol{\tau}\)</span>), spatially independent
random errors (<span class="math inline">\(\boldsymbol{\epsilon}\)</span>), and random
effects can also be obtained via <code><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted()</a></code> by changing the
<code>type</code> argument.</p>
<p>The residuals measure each response’s deviation from its fitted
value. The response residuals are given by <span class="math display">\[
  \mathbf{e}_{r} = \mathbf{y} - \hat{\mathbf{y}}.
\]</span> We compute the response residuals of the spatial model by
running</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">spmod</span><span class="op">)</span></span></code></pre></div>
<p>The response residuals are typically not directly checked for linear
model assumptions, as they have covariance closely resembling the
covariance of <span class="math inline">\(\mathbf{y}\)</span>.
Pre-multiplying the residuals by <span class="math inline">\(\boldsymbol{\Sigma}^{-1/2}\)</span> yields the
Pearson residuals <span class="citation">(Myers et al. 2012)</span>:
<span class="math display">\[
  \mathbf{e}_{p} = \boldsymbol{\Sigma}^{-1/2}\mathbf{e}_{r}.
\]</span> When the model is correct, the Pearson residuals have mean
zero, variance approximately one, and are uncorrelated. We compute the
Pearson residuals of the spatial model by running</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">spmod</span>, type <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span></span></code></pre></div>
<p>The covariance of <span class="math inline">\(\mathbf{e}_{p}\)</span>
is <span class="math inline">\((\mathbf{I} - \mathbf{H}^*)\)</span>,
which is approximately <span class="math inline">\(\mathbf{I}\)</span>
for large sample sizes. Explicitly dividing <span class="math inline">\(\mathbf{e}_{p}\)</span> by the respective diagonal
element of <span class="math inline">\((\mathbf{I} -
\mathbf{H}^*)\)</span> yields the standardized residuals <span class="citation">(Myers et al. 2012)</span>: <span class="math display">\[
  \mathbf{e}_{s} = \mathbf{e}_{p} \odot \frac{1}{\sqrt{(1 -
\text{diag}(\mathbf{H}^*))}},
\]</span> where <span class="math inline">\(\text{diag}(\mathbf{H}^*)\)</span> denotes the
diagonal of <span class="math inline">\(\mathbf{H}^*\)</span> and <span class="math inline">\(\odot\)</span> denotes the Hadmard (element-wise)
product. We compute the standardized residuals of the spatial model by
running</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">spmod</span>, type <span class="op">=</span> <span class="st">"standardized"</span><span class="op">)</span></span></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/influence.measures.html" class="external-link">rstandard</a></span><span class="op">(</span><span class="va">spmod</span><span class="op">)</span></span></code></pre></div>
<p>When the model is correct, the standardized residuals have mean zero,
variance one, and are uncorrelated. It is common to check linear model
assumptions through visualizations. We can plot the standardized
residuals vs fitted values by running</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">spmod</span>, which <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># figure omitted</span></span></code></pre></div>
<p>When the model is correct, the standardized residuals should be
evenly spread around zero with no discernible pattern. We can plot a
normal QQ-plot of the standardized residuals by running</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">spmod</span>, which <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># figure omitted</span></span></code></pre></div>
<p>When the standardized residuals are normally distributed, they should
closely follow the normal QQ-line.</p>
<p>An observation is said to be influential if its omission has a large
impact on model fit. Typically, this is measured using Cook’s distance
<span class="citation">(Cook and Weisberg 1982)</span>. For the
non-spatial model, the Cook’s distance of the <span class="math inline">\(i\)</span>th observation is denoted <span class="math inline">\(\mathbf{D}\)</span> and given by <span class="math display">\[
  \mathbf{D} = \frac{\mathbf{e}_{s}^2}{p} \odot \text{diag}(\mathbf{H})
\odot \frac{1}{(1 - \text{diag}(\mathbf{H}))},
\]</span> where <span class="math inline">\(p\)</span> is the dimension
of <span class="math inline">\(\boldsymbol{\beta}\)</span> (the number
of fixed effects).</p>
<p>For a spatial model, the Cook’s distance of the <span class="math inline">\(i\)</span>th observation is denoted <span class="math inline">\(\mathbf{D}^*\)</span> and given by <span class="math display">\[
\mathbf{D}^* = \frac{\mathbf{e}_{s}^2}{p} \odot
\text{diag}(\mathbf{H}^*) \odot \frac{1}{(1 -
\text{diag}(\mathbf{H}^*))} .
\]</span> A larger Cook’s distance indicates more influence, and
observations with large Cook’s distance values may be unusual and
warrant further investigation. We compute Cook’s distance by running</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/influence.measures.html" class="external-link">cooks.distance</a></span><span class="op">(</span><span class="va">spmod</span><span class="op">)</span></span></code></pre></div>
<p>The Cook’s distance versus leverage (hat values) can be visualized by
running</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">spmod</span>, which <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="co"># figure omitted</span></span></code></pre></div>
<p>Though we described the model diagnostics in this subsection using
<span class="math inline">\(\boldsymbol{\Sigma}\)</span>, generally the
covariance parameters are estimated and <span class="math inline">\(\boldsymbol{\Sigma}\)</span> is replaced with
<span class="math inline">\(\boldsymbol{\hat{\Sigma}}\)</span>.</p>
</div>
<div class="section level3">
<h3 id="the-broom-functions-tidy-glance-and-augment">The broom functions: <code>tidy()</code>, <code>glance()</code>, and
<code>augment()</code><a class="anchor" aria-label="anchor" href="#the-broom-functions-tidy-glance-and-augment"></a>
</h3>
<p>The <code><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy()</a></code>, <code><a href="https://generics.r-lib.org/reference/glance.html" class="external-link">glance()</a></code>, and
<code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code> functions from the broom package <span class="citation">(Robinson, Hayes, and Couch 2021)</span> provide
convenient output for many of the model fit and diagnostic metrics
discussed in the previous two sections. The <code><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy()</a></code> function
returns a tidy tibble of the coefficient table from
<code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">spmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 5</span></span></span>
<span><span class="co">#&gt;   term          estimate std.error statistic p.value</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> (Intercept)      9.77     0.252       38.7       0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> log_dist2road   -<span style="color: #BB0000;">0.563</span>    0.020<span style="text-decoration: underline;">1</span>     -<span style="color: #BB0000;">28.0</span>       0</span></span></code></pre>
<p>This tibble format makes it easy to pull out the coefficient names,
estimates, standard errors, z-statistics, and p-values from the
<code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> output.</p>
<p>The <code><a href="https://generics.r-lib.org/reference/glance.html" class="external-link">glance()</a></code> function returns a tidy tibble of model-fit
statistics:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/glance.html" class="external-link">glance</a></span><span class="op">(</span><span class="va">spmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 9</span></span></span>
<span><span class="co">#&gt;       n     p  npar value   AIC  AICc logLik deviance pseudo.r.squared</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>   365     2     3  367.  373.  373.  -<span style="color: #BB0000;">184.</span>     363.            0.683</span></span></code></pre>
<p>The <code><a href="../reference/glances.html">glances()</a></code> function is an extension of
<code><a href="https://generics.r-lib.org/reference/glance.html" class="external-link">glance()</a></code> that can be used to look at many models
simultaneously:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/glances.html">glances</a></span><span class="op">(</span><span class="va">spmod</span>, <span class="va">lmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 10</span></span></span>
<span><span class="co">#&gt;   model     n     p  npar value   AIC  AICc logLik deviance pseudo.r.squared</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> spmod   365     2     3  367.  373.  373.  -<span style="color: #BB0000;">184.</span>     363.            0.683</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> lmod    365     2     1  634.  636.  636.  -<span style="color: #BB0000;">317.</span>     363.            0.671</span></span></code></pre>
<p>Finally, the <code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code> function augments the original
data with model diagnostics:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="va">spmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Simple feature collection with 365 features and 7 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -445884.1 ymin: 1929616 xmax: -383656.8 ymax: 2061414</span></span>
<span><span class="co">#&gt; Projected CRS: NAD83 / Alaska Albers</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 365 × 8</span></span></span>
<span><span class="co">#&gt;    log_Zn log_dist2road .fitted .resid   .hat .cooksd .std.resid</span></span>
<span><span class="co">#&gt;  <span style="color: #BCBCBC;">*</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>   7.33          2.68    8.26 -<span style="color: #BB0000;">0.928</span> 0.020<span style="text-decoration: underline;">0</span> 0.014<span style="text-decoration: underline;">2</span>       1.18 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>   7.38          2.68    8.26 -<span style="color: #BB0000;">0.880</span> 0.020<span style="text-decoration: underline;">0</span> 0.018<span style="text-decoration: underline;">6</span>       1.35 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>   7.58          2.54    8.34 -<span style="color: #BB0000;">0.755</span> 0.022<span style="text-decoration: underline;">5</span> 0.004<span style="text-decoration: underline;">82</span>      0.647</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>   7.63          2.97    8.09 -<span style="color: #BB0000;">0.464</span> 0.019<span style="text-decoration: underline;">7</span> 0.030<span style="text-decoration: underline;">5</span>       1.74 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>   7.26          2.72    8.24 -<span style="color: #BB0000;">0.977</span> 0.021<span style="text-decoration: underline;">5</span> 0.131        3.45 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>   7.65          2.76    8.21 -<span style="color: #BB0000;">0.568</span> 0.028<span style="text-decoration: underline;">4</span> 0.052<span style="text-decoration: underline;">1</span>       1.89 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>   7.59          2.30    8.47 -<span style="color: #BB0000;">0.886</span> 0.030<span style="text-decoration: underline;">0</span> 0.059<span style="text-decoration: underline;">1</span>       1.96 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>   7.16          2.78    8.20 -<span style="color: #BB0000;">1.05</span>  0.033<span style="text-decoration: underline;">5</span> 0.003<span style="text-decoration: underline;">34</span>      0.439</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>   7.19          2.93    8.12 -<span style="color: #BB0000;">0.926</span> 0.037<span style="text-decoration: underline;">8</span> 0.030<span style="text-decoration: underline;">9</span>       1.26 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>   8.07          2.79    8.20 -<span style="color: #BB0000;">0.123</span> 0.031<span style="text-decoration: underline;">4</span> 0.008<span style="text-decoration: underline;">47</span>      0.723</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 355 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: geometry &lt;POINT [m]&gt;</span></span></span></code></pre>
<p>By default, only the columns of <code>data</code> used to fit the
model are returned alongside the diagnostics. All original columns of
<code>data</code> are returned by setting <code>drop</code> to
<code>FALSE</code>. <code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code> is especially powerful when
the data are an <code>sf</code> object because model diagnostics can be
easily visualized spatially. For example, we could subset the augmented
object so that it only includes observations whose standardized
residuals have absolute values greater than some cutoff and then
visualize them spatially. To learn more about the broom functions for
spatial linear models, run <code><a href="../reference/tidy.spmodel.html">help("tidy.splm", "spmodel")</a></code>,
<code><a href="../reference/glance.spmodel.html">help("glance.splm", "spmodel")</a></code>, and
<code><a href="../reference/augment.spmodel.html">help("augment.splm", "spmodel")</a></code>.</p>
</div>
<div class="section level3">
<h3 id="an-areal-data-example">An Areal Data Example<a class="anchor" aria-label="anchor" href="#an-areal-data-example"></a>
</h3>
<p>Next we use the <code>seal</code> data, an <code>sf</code> object
that contains the log of the estimated harbor-seal trends from abundance
data across polygons in Alaska, to provide an example of fitting a
spatial linear model for areal data using <code><a href="../reference/spautor.html">spautor()</a></code>. We
view the first few rows of <code>seal</code> by running</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seal</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Simple feature collection with 62 features and 1 field</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 913618.8 ymin: 1007542 xmax: 1116002 ymax: 1145054</span></span>
<span><span class="co">#&gt; Projected CRS: NAD83 / Alaska Albers</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 62 × 2</span></span></span>
<span><span class="co">#&gt;    log_trend                                                            geometry</span></span>
<span><span class="co">#&gt;        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                                                       <span style="color: #949494; font-style: italic;">&lt;POLYGON [m]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  <span style="color: #BB0000;">NA</span>       ((1035002 1054710, 1035002 1054542, 1035002 1053542, 1035002 10525…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  -<span style="color: #BB0000;">0.282</span>   ((1037002 1039492, 1037006 1039490, 1037017 1039492, 1037035 10394…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  -<span style="color: #BB0000;">0.001</span><span style="color: #BB0000; text-decoration: underline;">21</span> ((1070158 1030216, 1070185 1030207, 1070187 1030207, 1070211 10302…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>   0.035<span style="text-decoration: underline;">4</span>  ((1054906 1034826, 1054931 1034821, 1054936 1034822, 1055001 10348…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  -<span style="color: #BB0000;">0.016</span><span style="color: #BB0000; text-decoration: underline;">0</span>  ((1025142 1056940, 1025184 1056889, 1025222 1056836, 1025256 10567…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>   0.087<span style="text-decoration: underline;">2</span>  ((1026035 1044623, 1026037 1044605, 1026072 1044610, 1026083 10446…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  -<span style="color: #BB0000;">0.266</span>   ((1100345 1060709, 1100287 1060706, 1100228 1060706, 1100170 10607…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>   0.074<span style="text-decoration: underline;">3</span>  ((1030247 1029637, 1030248 1029637, 1030265 1029642, 1030328 10296…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  <span style="color: #BB0000;">NA</span>       ((1043093 1020553, 1043097 1020550, 1043101 1020550, 1043166 10205…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  -<span style="color: #BB0000;">0.009</span><span style="color: #BB0000; text-decoration: underline;">61</span> ((1116002 1024542, 1116002 1023542, 1116002 1022542, 1116002 10215…</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 52 more rows</span></span></span></code></pre>
<p>We can learn more about the data by running
<code><a href="../reference/seal.html">help("seal", "spmodel")</a></code>.</p>
<p>We can visualize the distribution of log seal trends in the
<code>seal</code> data by running</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">seal</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">log_trend</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> </span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="guide_files/figure-html/log_trend-1.png" alt="Distribution of log seal trends in the seal data. Polygons are gray if seal trends are missing." width="65%"><p class="caption">
Distribution of log seal trends in the seal data. Polygons are gray if
seal trends are missing.
</p>
</div>
<p>Log trends can be viewed interactively in <code>mapview</code> by
running</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mapview</span><span class="op">(</span><span class="va">seal</span>, zcol <span class="op">=</span> <span class="st">"log_trend"</span><span class="op">)</span></span></code></pre></div>
<p>The gray polygons denote areas where the log trend is missing. These
missing areas need to be kept in the data while fitting the model to
preserve the overall neighborhood structure.</p>
<p>We estimate parameters of a spatial autoregressive model for log seal
trends (<code>log_trend</code>) using an intercept-only model with a
conditional autoregressive (CAR) spatial covariance by running</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sealmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spautor.html">spautor</a></span><span class="op">(</span><span class="va">log_trend</span> <span class="op">~</span> <span class="fl">1</span>, <span class="va">seal</span>, spcov_type <span class="op">=</span> <span class="st">"car"</span><span class="op">)</span></span></code></pre></div>
<p>If a weight matrix is not provided to <code><a href="../reference/spautor.html">spautor()</a></code>, it is
calculated internally using queen contiguity. Recall queen contiguity
defines two observations as neighbors if they share at least one common
boundary. If at least one observation has no neighbors, the
<code>extra</code> parameter is estimated, which quantifies variability
among observations without neighbors. By default, <code><a href="../reference/spautor.html">spautor()</a></code>
uses row standardization <span class="citation">(Ver Hoef et al.
2018)</span> and assumes an independent error variance (<code>ie</code>)
of zero.</p>
<p>We summarize, tidy, glance at, and augment the fitted model by
running</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">sealmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; spautor(formula = log_trend ~ 1, data = seal, spcov_type = "car")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -0.34441 -0.10403  0.04423  0.07351  0.20489 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients (fixed):</span></span>
<span><span class="co">#&gt;             Estimate Std. Error z value Pr(&gt;|z|)   </span></span>
<span><span class="co">#&gt; (Intercept) -0.07103    0.02492  -2.851  0.00436 **</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients (car spatial covariance):</span></span>
<span><span class="co">#&gt;      de   range   extra </span></span>
<span><span class="co">#&gt; 0.03226 0.42020 0.02235</span></span></code></pre>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">sealmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 5</span></span></span>
<span><span class="co">#&gt;   term        estimate std.error statistic p.value</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> (Intercept)  -<span style="color: #BB0000;">0.071</span><span style="color: #BB0000; text-decoration: underline;">0</span>    0.024<span style="text-decoration: underline;">9</span>     -<span style="color: #BB0000;">2.85</span> 0.004<span style="text-decoration: underline;">36</span></span></span></code></pre>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/glance.html" class="external-link">glance</a></span><span class="op">(</span><span class="va">sealmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 9</span></span></span>
<span><span class="co">#&gt;       n     p  npar value   AIC  AICc logLik deviance pseudo.r.squared</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>    34     1     3 -<span style="color: #BB0000;">36.9</span> -<span style="color: #BB0000;">30.9</span> -<span style="color: #BB0000;">30.1</span>   18.4     33.2                0</span></span></code></pre>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="va">sealmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Simple feature collection with 34 features and 6 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 980001.5 ymin: 1010815 xmax: 1116002 ymax: 1145054</span></span>
<span><span class="co">#&gt; Projected CRS: NAD83 / Alaska Albers</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 34 × 7</span></span></span>
<span><span class="co">#&gt;    log_trend .fitted  .resid   .hat .cooksd .std.resid                  geometry</span></span>
<span><span class="co">#&gt;  <span style="color: #BCBCBC;">*</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;POLYGON [m]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  -<span style="color: #BB0000;">0.282</span>   -<span style="color: #BB0000;">0.071</span><span style="color: #BB0000; text-decoration: underline;">0</span> -<span style="color: #BB0000;">0.211</span>  0.016<span style="text-decoration: underline;">2</span> 0.021<span style="text-decoration: underline;">1</span>      -<span style="color: #BB0000;">1.13</span>  ((1037002 1039492, 10370…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  -<span style="color: #BB0000;">0.001</span><span style="color: #BB0000; text-decoration: underline;">21</span> -<span style="color: #BB0000;">0.071</span><span style="color: #BB0000; text-decoration: underline;">0</span>  0.069<span style="text-decoration: underline;">8</span> 0.047<span style="text-decoration: underline;">5</span> 0.026<span style="text-decoration: underline;">0</span>       0.722 ((1070158 1030216, 10701…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>   0.035<span style="text-decoration: underline;">4</span>  -<span style="color: #BB0000;">0.071</span><span style="color: #BB0000; text-decoration: underline;">0</span>  0.106  0.029<span style="text-decoration: underline;">2</span> 0.018<span style="text-decoration: underline;">5</span>       0.786 ((1054906 1034826, 10549…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  -<span style="color: #BB0000;">0.016</span><span style="color: #BB0000; text-decoration: underline;">0</span>  -<span style="color: #BB0000;">0.071</span><span style="color: #BB0000; text-decoration: underline;">0</span>  0.055<span style="text-decoration: underline;">0</span> 0.022<span style="text-decoration: underline;">9</span> 0.001<span style="text-decoration: underline;">60</span>      0.262 ((1025142 1056940, 10251…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>   0.087<span style="text-decoration: underline;">2</span>  -<span style="color: #BB0000;">0.071</span><span style="color: #BB0000; text-decoration: underline;">0</span>  0.158  0.027<span style="text-decoration: underline;">7</span> 0.038<span style="text-decoration: underline;">9</span>       1.17  ((1026035 1044623, 10260…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  -<span style="color: #BB0000;">0.266</span>   -<span style="color: #BB0000;">0.071</span><span style="color: #BB0000; text-decoration: underline;">0</span> -<span style="color: #BB0000;">0.195</span>  0.027<span style="text-decoration: underline;">8</span> 0.049<span style="text-decoration: underline;">9</span>      -<span style="color: #BB0000;">1.32</span>  ((1100345 1060709, 11002…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>   0.074<span style="text-decoration: underline;">3</span>  -<span style="color: #BB0000;">0.071</span><span style="color: #BB0000; text-decoration: underline;">0</span>  0.145  0.049<span style="text-decoration: underline;">3</span> 0.091<span style="text-decoration: underline;">4</span>       1.33  ((1030247 1029637, 10302…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  -<span style="color: #BB0000;">0.009</span><span style="color: #BB0000; text-decoration: underline;">61</span> -<span style="color: #BB0000;">0.071</span><span style="color: #BB0000; text-decoration: underline;">0</span>  0.061<span style="text-decoration: underline;">4</span> 0.012<span style="text-decoration: underline;">3</span> 0.002<span style="text-decoration: underline;">45</span>      0.445 ((1116002 1024542, 11160…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  -<span style="color: #BB0000;">0.182</span>   -<span style="color: #BB0000;">0.071</span><span style="color: #BB0000; text-decoration: underline;">0</span> -<span style="color: #BB0000;">0.111</span>  0.022<span style="text-decoration: underline;">6</span> 0.022<span style="text-decoration: underline;">6</span>      -<span style="color: #BB0000;">0.990</span> ((1079864 1025088, 10798…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>   0.003<span style="text-decoration: underline;">51</span> -<span style="color: #BB0000;">0.071</span><span style="color: #BB0000; text-decoration: underline;">0</span>  0.074<span style="text-decoration: underline;">5</span> 0.031<span style="text-decoration: underline;">7</span> 0.010<span style="text-decoration: underline;">2</span>       0.558 ((1110363 1037056, 11103…</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 24 more rows</span></span></span></code></pre>
<p>Note that for <code><a href="../reference/spautor.html">spautor()</a></code> models, the <code>ie</code>
spatial covariance parameter is assumed zero by default (and omitted
from the <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> output). This default behavior can be
overridden by specifying <code>ie</code> in the
<code>spcov_initial</code> argument to <code><a href="../reference/spautor.html">spautor()</a></code>. Also note
that the pseudo R-squared is zero because there are no explanatory
variables in the model (i.e., it is an intercept-only model).</p>
</div>
</div>
<div class="section level2">
<h2 id="sec:prediction">Prediction<a class="anchor" aria-label="anchor" href="#sec:prediction"></a>
</h2>
<p>In this section, we show how to use <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> to perform
spatial prediction (also called Kriging) in <code>spmodel</code>. We
will fit a model using the point-referenced <code>sulfate</code> data,
an <code>sf</code> object that contains sulfate measurements in the
conterminous United States, and make predictions for each location in
the point-referenced <code>sulfate_preds</code> data, an <code>sf</code>
object that contains locations in the conterminous United States at
which to predict sulfate.</p>
<p>We first visualize the distribution of the sulfate data by
running</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sulfate</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">sulfate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">45</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_gray</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span></span></code></pre></div>
<p>We then fit a spatial linear model for sulfate using an
intercept-only model with a spherical spatial covariance function by
running</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sulfmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/splm.html">splm</a></span><span class="op">(</span><span class="va">sulfate</span> <span class="op">~</span> <span class="fl">1</span>, <span class="va">sulfate</span>, spcov_type <span class="op">=</span> <span class="st">"spherical"</span><span class="op">)</span></span></code></pre></div>
<p>Then we obtain best linear unbiased predictions (Kriging predictions)
using <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>, where the <code>newdata</code> argument
contains the locations at which to predict, storing them as a new
variable in <code>sulfate_preds</code> called <code>preds</code>:</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sulfate_preds</span><span class="op">$</span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">sulfmod</span>, newdata <span class="op">=</span> <span class="va">sulfate_preds</span><span class="op">)</span></span></code></pre></div>
<p>We can visualize the model predictions by running</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sulfate_preds</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">preds</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">45</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_gray</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="guide_files/figure-html/sulfate-1.png" alt="Distribution of observed sulfate (left) and sulfate predictions (right) in the conterminous United States." width="49%"><img src="guide_files/figure-html/sulfate-2.png" alt="Distribution of observed sulfate (left) and sulfate predictions (right) in the conterminous United States." width="49%"><p class="caption">
Distribution of observed sulfate (left) and sulfate predictions (right)
in the conterminous United States.
</p>
</div>
<p>Before making predictions, it is important to properly specify the
<code>newdata</code> object. If explanatory variables were used to fit
the model, the same explanatory variables must be included in
<code>newdata</code> with the same names they have in <code>data</code>.
Additionally, if an explanatory variable is categorical or a factor, the
values of this variable in <code>newdata</code> must also be values in
<code>data</code> (e.g., if a categorical variable with values
<code>"A"</code>, and <code>"B"</code> was used to fit the model, the
corresponding variable in <code>newdata</code> cannot have a value
<code>"C"</code>). If <code>data</code> is a <code>data.frame</code>,
coordinates must be included in <code>newdata</code> with the same names
as they have in <code>data</code>. If <code>data</code> is an
<code>sf</code> object, coordinates must be included in
<code>newdata</code> with the same geometry name as they have in
<code>data</code>. When using projected coordinates, the projection for
<code>newdata</code> should be the same as the projection for
<code>data</code>.</p>
<p>Prediction standard errors are returned by setting the
<code>se.fit</code> argument to <code>TRUE</code>:</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">sulfmod</span>, newdata <span class="op">=</span> <span class="va">sulfate_preds</span>, se.fit <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The <code>interval</code> argument determines the type of interval
returned. If <code>interval</code> is <code>"none"</code> (the default),
no intervals are returned. If <code>interval</code> is
<code>"prediction"</code>, <code>100 * level</code>% prediction
intervals are returned (the default is 95% prediction intervals):</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">sulfmod</span>, newdata <span class="op">=</span> <span class="va">sulfate_preds</span>, interval <span class="op">=</span> <span class="st">"prediction"</span><span class="op">)</span></span></code></pre></div>
<p>If <code>interval</code> is <code>"confidence"</code>, the
predictions are instead the estimated mean given each observation’s
explanatory variable values. The corresponding <code>100 * level</code>%
confidence intervals are returned:</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">sulfmod</span>, newdata <span class="op">=</span> <span class="va">sulfate_preds</span>, interval <span class="op">=</span> <span class="st">"confidence"</span><span class="op">)</span></span></code></pre></div>
<p>Previously we used the <code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code> function to augment
<code>data</code> with model diagnostics. We can also use
<code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code> as an alternative to <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> to
augment <code>newdata</code> with predictions, standard errors, and
intervals. We remove the model predictions from
<code>sulfate_preds</code> before showing how <code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code> is
used to obtain the same predictions by running</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sulfate_preds</span><span class="op">$</span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span></code></pre></div>
<p>We then view the first few rows of <code>sulfate_preds</code>
augmented with 90% prediction intervals by running</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="va">sulfmod</span>, newdata <span class="op">=</span> <span class="va">sulfate_preds</span>, interval <span class="op">=</span> <span class="st">"prediction"</span>, level <span class="op">=</span> <span class="fl">0.90</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Simple feature collection with 100 features and 3 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -2283774 ymin: 582930.5 xmax: 1985906 ymax: 3037173</span></span>
<span><span class="co">#&gt; Projected CRS: NAD83 / Conus Albers</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 100 × 4</span></span></span>
<span><span class="co">#&gt;    .fitted .lower .upper            geometry</span></span>
<span><span class="co">#&gt;  <span style="color: #BCBCBC;">*</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>    1.40  -<span style="color: #BB0000;">5.33</span>   8.14  (-1771413 1752976)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>   24.5   18.2   30.8    (1018112 1867127)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>    8.99   2.36  15.6  (-291256.8 1553212)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>   16.4    9.92  23.0    (1274293 1267835)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>    4.91  -<span style="color: #BB0000;">1.56</span>  11.4  (-547437.6 1638825)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>   26.7   20.4   33.0    (1445080 1981278)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>    3.00  -<span style="color: #BB0000;">3.65</span>   9.66  (-1629090 3037173)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>   14.3    7.97  20.6    (1302757 1039534)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>    1.49  -<span style="color: #BB0000;">5.08</span>   8.06  (-1429838 2523494)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>   14.4    7.97  20.8    (1131970 1096609)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 90 more rows</span></span></span></code></pre>
<p>Here, <code>.fitted</code> represents the predictions.</p>
<p>An alternative (but equivalent) approach can be used for model
fitting and prediction that circumvents the need to keep
<code>data</code> and <code>newdata</code> as separate objects. Suppose
that observations requiring prediction are stored in <code>data</code>
as missing (<code>NA</code>) values. We can add a column of missing
values to <code>sulfate_preds</code> and then bind it together with
<code>sulfate</code> by running</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sulfate_preds</span><span class="op">$</span><span class="va">sulfate</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">sulfate_with_NA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">sulfate</span>, <span class="va">sulfate_preds</span><span class="op">)</span></span></code></pre></div>
<p>We can then fit a spatial linear model by running</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sulfmod_with_NA</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/splm.html">splm</a></span><span class="op">(</span><span class="va">sulfate</span> <span class="op">~</span> <span class="fl">1</span>, <span class="va">sulfate_with_NA</span>, <span class="st">"spherical"</span><span class="op">)</span></span></code></pre></div>
<p>The missing values are ignored for model-fitting but stored in
<code>sulfmod_with_NA</code> as <code>newdata</code>:</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sulfmod_with_NA</span><span class="op">$</span><span class="va">newdata</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Simple feature collection with 100 features and 1 field</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -2283774 ymin: 582930.5 xmax: 1985906 ymax: 3037173</span></span>
<span><span class="co">#&gt; Projected CRS: NAD83 / Conus Albers</span></span>
<span><span class="co">#&gt; First 10 features:</span></span>
<span><span class="co">#&gt;     sulfate                  geometry</span></span>
<span><span class="co">#&gt; 198      NA  POINT (-1771413 1752976)</span></span>
<span><span class="co">#&gt; 199      NA   POINT (1018112 1867127)</span></span>
<span><span class="co">#&gt; 200      NA POINT (-291256.8 1553212)</span></span>
<span><span class="co">#&gt; 201      NA   POINT (1274293 1267835)</span></span>
<span><span class="co">#&gt; 202      NA POINT (-547437.6 1638825)</span></span>
<span><span class="co">#&gt; 203      NA   POINT (1445080 1981278)</span></span>
<span><span class="co">#&gt; 204      NA  POINT (-1629090 3037173)</span></span>
<span><span class="co">#&gt; 205      NA   POINT (1302757 1039534)</span></span>
<span><span class="co">#&gt; 206      NA  POINT (-1429838 2523494)</span></span>
<span><span class="co">#&gt; 207      NA   POINT (1131970 1096609)</span></span></code></pre>
<p>We can then predict the missing values by running</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">sulfmod_with_NA</span><span class="op">)</span></span></code></pre></div>
<p>The call to <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> finds in
<code>sulfmod_with_NA</code> the <code>newdata</code> object and is
equivalent to</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">sulfmod_with_NA</span>, newdata <span class="op">=</span> <span class="va">sulfmod_with_NA</span><span class="op">$</span><span class="va">newdata</span><span class="op">)</span></span></code></pre></div>
<p>We can also use <code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code> to make the predictions on the
data set with missing values by running</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="va">sulfmod_with_NA</span>, newdata <span class="op">=</span> <span class="va">sulfmod_with_NA</span><span class="op">$</span><span class="va">newdata</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Simple feature collection with 100 features and 2 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -2283774 ymin: 582930.5 xmax: 1985906 ymax: 3037173</span></span>
<span><span class="co">#&gt; Projected CRS: NAD83 / Conus Albers</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 100 × 3</span></span></span>
<span><span class="co">#&gt;    sulfate .fitted            geometry</span></span>
<span><span class="co">#&gt;  <span style="color: #BCBCBC;">*</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>      <span style="color: #BB0000;">NA</span>    1.40  (-1771413 1752976)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>      <span style="color: #BB0000;">NA</span>   24.5    (1018112 1867127)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>      <span style="color: #BB0000;">NA</span>    8.99 (-291256.8 1553212)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>      <span style="color: #BB0000;">NA</span>   16.4    (1274293 1267835)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>      <span style="color: #BB0000;">NA</span>    4.91 (-547437.6 1638825)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>      <span style="color: #BB0000;">NA</span>   26.7    (1445080 1981278)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>      <span style="color: #BB0000;">NA</span>    3.00  (-1629090 3037173)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>      <span style="color: #BB0000;">NA</span>   14.3    (1302757 1039534)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>      <span style="color: #BB0000;">NA</span>    1.49  (-1429838 2523494)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>      <span style="color: #BB0000;">NA</span>   14.4    (1131970 1096609)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 90 more rows</span></span></span></code></pre>
<p>Unlike <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>, <code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code> explicitly
requires the <code>newdata</code> argument be specified in order to
obtain predictions. Omitting <code>newdata</code> (e.g., running
<code>augment(sulfmod_with_NA)</code>) returns model diagnostics, not
predictions.</p>
<p>For areal data models fit with <code><a href="../reference/spautor.html">spautor()</a></code>, predictions
cannot be computed at locations that were not incorporated in the
neighborhood structure used to fit the model. Thus, predictions are only
possible for observations in <code>data</code> whose response values are
missing (<code>NA</code>), as their locations are incorporated into the
neighborhood structure. For example, we make predictions of log seal
trends at the missing polygons by running</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">sealmod</span><span class="op">)</span></span></code></pre></div>
<p>We can also use <code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code> to make the predictions:</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="va">sealmod</span>, newdata <span class="op">=</span> <span class="va">sealmod</span><span class="op">$</span><span class="va">newdata</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Simple feature collection with 28 features and 2 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 913618.8 ymin: 1007542 xmax: 1115097 ymax: 1132682</span></span>
<span><span class="co">#&gt; Projected CRS: NAD83 / Alaska Albers</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 28 × 3</span></span></span>
<span><span class="co">#&gt;    log_trend  .fitted                                                   geometry</span></span>
<span><span class="co">#&gt;  <span style="color: #BCBCBC;">*</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                                              <span style="color: #949494; font-style: italic;">&lt;POLYGON [m]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>        <span style="color: #BB0000;">NA</span> -<span style="color: #BB0000;">0.115</span>   ((1035002 1054710, 1035002 1054542, 1035002 1053542, 1035…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>        <span style="color: #BB0000;">NA</span> -<span style="color: #BB0000;">0.009</span><span style="color: #BB0000; text-decoration: underline;">18</span> ((1043093 1020553, 1043097 1020550, 1043101 1020550, 1043…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>        <span style="color: #BB0000;">NA</span> -<span style="color: #BB0000;">0.060</span><span style="color: #BB0000; text-decoration: underline;">3</span>  ((1099737 1054310, 1099752 1054262, 1099788 1054278, 1099…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>        <span style="color: #BB0000;">NA</span> -<span style="color: #BB0000;">0.036</span><span style="color: #BB0000; text-decoration: underline;">0</span>  ((1099002 1036542, 1099134 1036462, 1099139 1036431, 1099…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>        <span style="color: #BB0000;">NA</span> -<span style="color: #BB0000;">0.072</span><span style="color: #BB0000; text-decoration: underline;">4</span>  ((1076902 1053189, 1076912 1053179, 1076931 1053179, 1076…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>        <span style="color: #BB0000;">NA</span> -<span style="color: #BB0000;">0.054</span><span style="color: #BB0000; text-decoration: underline;">9</span>  ((1070501 1046969, 1070317 1046598, 1070308 1046542, 1070…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>        <span style="color: #BB0000;">NA</span> -<span style="color: #BB0000;">0.097</span><span style="color: #BB0000; text-decoration: underline;">6</span>  ((1072995 1054942, 1072996 1054910, 1072997 1054878, 1072…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>        <span style="color: #BB0000;">NA</span> -<span style="color: #BB0000;">0.071</span><span style="color: #BB0000; text-decoration: underline;">5</span>  ((960001.5 1127667, 960110.8 1127542, 960144.1 1127495, 9…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>        <span style="color: #BB0000;">NA</span> -<span style="color: #BB0000;">0.082</span><span style="color: #BB0000; text-decoration: underline;">5</span>  ((1031308 1079817, 1031293 1079754, 1031289 1079741, 1031…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>        <span style="color: #BB0000;">NA</span> -<span style="color: #BB0000;">0.059</span><span style="color: #BB0000; text-decoration: underline;">3</span>  ((998923.7 1053647, 998922.5 1053609, 998950 1053631, 999…</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 18 more rows</span></span></span></code></pre>
</div>
<div class="section level2">
<h2 id="sec:advfeatures">Advanced Features<a class="anchor" aria-label="anchor" href="#sec:advfeatures"></a>
</h2>
<p><code>spmodel</code> offers several advanced features for fitting
spatial linear models. We briefly discuss some of these features next
using the <code>moss</code> data, the <code>moose</code> data, and some
simulated data. Technical details for each advanced feature can be seen
by running <code><a href="../articles/technical.html">vignette("technical", "spmodel")</a></code>.</p>
<div class="section level3">
<h3 id="sec:spcov_init">Fixing Spatial Covariance Parameters<a class="anchor" aria-label="anchor" href="#sec:spcov_init"></a>
</h3>
<p>We may desire to fix specific spatial covariance parameters at a
particular value. Perhaps some parameter value is known, for example. Or
perhaps we want to compare nested models where a reduced model uses a
fixed parameter value while the full model estimates the parameter.
Fixing spatial covariance parameters while fitting a model is possible
using the <code>spcov_initial</code> argument to <code><a href="../reference/splm.html">splm()</a></code> and
<code><a href="../reference/spautor.html">spautor()</a></code>. The <code>spcov_initial</code> argument takes an
<code>spcov_initial</code> object (run
<code><a href="../reference/spcov_initial.html">help("spcov_initial", "spmodel")</a></code> for more).
<code>spcov_initial</code> objects can also be used to specify initial
values used during optimization, even if they are not assumed to be
fixed. By default, <code>spmodel</code> uses a grid search to find
suitable initial values to use during optimization.</p>
<p>As an example, suppose our goal is to compare a model with an
exponential covariance with dependent error variance, independent error
variance, and range parameters to a model that assumes the independent
random error variance parameter (nugget) is zero. First, the
<code>spcov_initial</code> object is specified for the latter model:</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">init</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spcov_initial.html">spcov_initial</a></span><span class="op">(</span><span class="st">"exponential"</span>, ie <span class="op">=</span> <span class="fl">0</span>, known <span class="op">=</span> <span class="st">"ie"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">init</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; $initial</span></span>
<span><span class="co">#&gt; ie </span></span>
<span><span class="co">#&gt;  0 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $is_known</span></span>
<span><span class="co">#&gt;   ie </span></span>
<span><span class="co">#&gt; TRUE </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attr(,"class")</span></span>
<span><span class="co">#&gt; [1] "exponential"</span></span></code></pre>
<p>The <code>init</code> output shows that the <code>ie</code> parameter
has an initial value of zero that is assumed to be known. Next the model
is fit:</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spmod_red</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/splm.html">splm</a></span><span class="op">(</span><span class="va">log_Zn</span> <span class="op">~</span> <span class="va">log_dist2road</span>, <span class="va">moss</span>, spcov_initial <span class="op">=</span> <span class="va">init</span><span class="op">)</span></span></code></pre></div>
<p>Notice that because the <code>spcov_initial</code> object contains
information about the spatial covariance type, the
<code>spcov_type</code> argument is not required when
<code>spcov_initial</code> is provided. We can use
<code><a href="../reference/glances.html">glances()</a></code> to glance at both models:</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/glances.html">glances</a></span><span class="op">(</span><span class="va">spmod</span>, <span class="va">spmod_red</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 10</span></span></span>
<span><span class="co">#&gt;   model         n     p  npar value   AIC  AICc logLik deviance pseudo.r.squared</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> spmod       365     2     3  367.  373.  373.  -<span style="color: #BB0000;">184.</span>     363.            0.683</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> spmod_red   365     2     2  378.  382.  382.  -<span style="color: #BB0000;">189.</span>     374.            0.703</span></span></code></pre>
<p>The lower AIC and AICc of the full model compared to the reduced
model indicates that the independent random error variance is important
to the model. A likelihood ratio test comparing the full and reduced
models is also possible using <code><a href="https://rdrr.io/r/stats/anova.html" class="external-link">anova()</a></code>.</p>
<p>Another application of fixing spatial covariance parameters involves
calculating their profile likelihood confidence intervals <span class="citation">(Box and Cox 1964)</span>. Before calculating a profile
likelihood confidence interval for <span class="math inline">\(\boldsymbol{\Theta}_i\)</span>, the <span class="math inline">\(i\)</span>th element of a general parameter vector
<span class="math inline">\(\boldsymbol{\Theta}\)</span>, it is
necessary to obtain <span class="math inline">\(-2\ell(\hat{\boldsymbol{\Theta}})\)</span>, minus
twice the log-likelihood evaluated at the estimated parameter vector,
<span class="math inline">\(\hat{\boldsymbol{\Theta}}\)</span>. Then a
<span class="math inline">\((1 - \alpha)\)</span>% profile likelihood
confidence interval is the set of values for <span class="math inline">\(\boldsymbol{\Theta}_i\)</span> such that <span class="math inline">\(2\ell(\hat{\boldsymbol{\Theta}}) -
2\ell(\hat{\boldsymbol{\Theta}}_{-i}) \leq \chi^2_{1, 1 -
\alpha}\)</span>, where <span class="math inline">\(\ell(\hat{\boldsymbol{\Theta}}_{-i})\)</span> is
the value of the log-likelihood maximized after fixing <span class="math inline">\(\boldsymbol{\Theta}_i\)</span> and optimizing over
the remaining parameters, <span class="math inline">\(\boldsymbol{\Theta}_{-i}\)</span>, and <span class="math inline">\(\chi^2_{1, 1 - \alpha}\)</span> is the <span class="math inline">\(1 - \alpha\)</span> quantile of a chi-squared
distribution with one degree of freedom. The result follows from
inverting a likelihood ratio test comparing the full model to a reduced
model that fixes the value of <span class="math inline">\(\boldsymbol{\Theta}_i\)</span>. Because this
approach requires refitting the model many times for different fixed
values of <span class="math inline">\(\boldsymbol{\Theta}_i\)</span>, it
can be computationally intensive. This approached can be generalized to
yield joint profile likelihood confidence intervals cases when <span class="math inline">\(i\)</span> has dimension greater than one.</p>
</div>
<div class="section level3">
<h3 id="fitting-and-predicting-for-multiple-models">Fitting and Predicting for Multiple Models<a class="anchor" aria-label="anchor" href="#fitting-and-predicting-for-multiple-models"></a>
</h3>
<p>Fitting multiple models is possible with a single call to
<code><a href="../reference/splm.html">splm()</a></code> or <code><a href="../reference/spautor.html">spautor()</a></code> when
<code>spcov_type</code> is a vector with length greater than one or
<code>spcov_initial</code> is a list (with length greater than one) of
<code>spcov_initial</code> objects. We fit three separate spatial linear
models using the exponential spatial covariance, spherical spatial
covariance, and no spatial covariance by running</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spmods</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/splm.html">splm</a></span><span class="op">(</span><span class="va">sulfate</span> <span class="op">~</span> <span class="fl">1</span>, <span class="va">sulfate</span>, spcov_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"exponential"</span>, <span class="st">"spherical"</span>, <span class="st">"none"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><code>spmods</code> is list whose names indicate the spatial
covariance type and whose values indicate the model fit for that spatial
covariance type. Generic functions can be called individually for each
list element. For example, we can augment the the model fit using the
exponential covariance function with diagnostics by running</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="va">spmods</span><span class="op">$</span><span class="va">exponential</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Simple feature collection with 197 features and 6 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -2292550 ymin: 386181.1 xmax: 2173345 ymax: 3090370</span></span>
<span><span class="co">#&gt; Projected CRS: NAD83 / Conus Albers</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 197 × 7</span></span></span>
<span><span class="co">#&gt;    sulfate .fitted .resid    .hat   .cooksd .std.resid           geometry</span></span>
<span><span class="co">#&gt;  <span style="color: #BCBCBC;">*</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  12.9      5.92   7.00 0.003<span style="text-decoration: underline;">34</span> 0.001<span style="text-decoration: underline;">61</span>      -<span style="color: #BB0000;">0.694</span>  (817738.8 1080571)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  20.2      5.92  14.2  0.002<span style="text-decoration: underline;">56</span> 0.001<span style="text-decoration: underline;">92</span>       0.865  (914593.6 1295545)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  16.8      5.92  10.9  0.002<span style="text-decoration: underline;">59</span> 0.000<span style="text-decoration: underline;">395</span>      0.390  (359574.1 1178228)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  16.2      5.92  10.3  0.002<span style="text-decoration: underline;">39</span> 0.000<span style="text-decoration: underline;">363</span>      0.390  (265331.9 1239089)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>   7.86     5.92   1.93 0.002<span style="text-decoration: underline;">02</span> 0.008<span style="text-decoration: underline;">71</span>      -<span style="color: #BB0000;">2.07</span>   (304528.8 1453636)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  15.4      5.92   9.43 0.002<span style="text-decoration: underline;">01</span> 0.000<span style="text-decoration: underline;">240</span>      0.345  (162932.8 1451625)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>   0.986    5.92  -<span style="color: #BB0000;">4.94</span> 0.003<span style="text-decoration: underline;">80</span> 0.000<span style="text-decoration: underline;">966</span>     -<span style="color: #BB0000;">0.503</span>  (-1437776 1568022)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>   0.425    5.92  -<span style="color: #BB0000;">5.50</span> 0.013<span style="text-decoration: underline;">8</span>  0.005<span style="text-decoration: underline;">84</span>      -<span style="color: #BB0000;">0.646</span>  (-1572878 1125529)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>   3.58     5.92  -<span style="color: #BB0000;">2.34</span> 0.006<span style="text-decoration: underline;">73</span> 0.000<span style="text-decoration: underline;">014</span>8    -<span style="color: #BB0000;">0.046</span><span style="color: #BB0000; text-decoration: underline;">7</span> (-1282009 1204889)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>   2.38     5.92  -<span style="color: #BB0000;">3.54</span> 0.012<span style="text-decoration: underline;">3</span>  0.000<span style="text-decoration: underline;">013</span>9    -<span style="color: #BB0000;">0.033</span><span style="color: #BB0000; text-decoration: underline;">5</span> (-1972775 1464991)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 187 more rows</span></span></span></code></pre>
<p>Or we can find the AIC of the model fit using the spherical
covariance function by running</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">spmods</span><span class="op">$</span><span class="va">spherical</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 1143.202</span></span></code></pre>
<p>The <code><a href="../reference/glances.html">glances()</a></code> and <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> functions can
work directly with <code>spmods</code>, calling <code><a href="../reference/glances.html">glances()</a></code>
and <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> on each list element and then organizing the
results. We glance at each fitted model object by running</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/glances.html">glances</a></span><span class="op">(</span><span class="va">spmods</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 10</span></span></span>
<span><span class="co">#&gt;   model         n     p  npar value   AIC  AICc logLik deviance pseudo.r.squared</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> spherical   197     1     3 <span style="text-decoration: underline;">1</span>137. <span style="text-decoration: underline;">1</span>143. <span style="text-decoration: underline;">1</span>143.  -<span style="color: #BB0000;">569.</span>     196.                0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> exponent…   197     1     3 <span style="text-decoration: underline;">1</span>140. <span style="text-decoration: underline;">1</span>146. <span style="text-decoration: underline;">1</span>146.  -<span style="color: #BB0000;">570.</span>     196.                0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> none        197     1     1 <span style="text-decoration: underline;">1</span>448. <span style="text-decoration: underline;">1</span>450. <span style="text-decoration: underline;">1</span>450.  -<span style="color: #BB0000;">724.</span>     196                 0</span></span></code></pre>
<p>We predict <code>newdata</code> separately for each fitted model
object by running</p>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">spmods</span>, newdata <span class="op">=</span> <span class="va">sulfate_preds</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="random-effects">Random Effects<a class="anchor" aria-label="anchor" href="#random-effects"></a>
</h3>
<p>Non-spatial random effects incorporate additional sources of
variability into model fitting. They are accommodated in
<code>spmodel</code> using similar syntax as for random effects in the
<code>nlme</code> <span class="citation">(Pinheiro and Bates
2006)</span> and <code>lme4</code> <span class="citation">(Bates et al.
2015)</span> packages. Random effects are specified via a formula passed
to the <code>random</code> argument. Next we show two examples that
incorporate random effects into the spatial linear model using the
<code>moss</code> data.</p>
<p>The first example explores random intercepts for the
<code>sample</code> variable. The <code>sample</code> variable indexes
each unique location, which can have replicate observations due to field
duplicates (<code>field_dup</code>) and lab replicates
(<code>lab_rep</code>). There are 365 observations in <code>moss</code>
at 318 unique locations, which means that 47 observations in
<code>moss</code> are either field duplicates or lab replicates. It is
likely that the repeated observations at a location are correlated with
one another. We can incorporate this repeated-observation correlation by
creating a random intercept for each level of <code>sample</code>. We
model the random intercepts for <code>sample</code> by running</p>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rand1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/splm.html">splm</a></span><span class="op">(</span></span>
<span>  <span class="va">log_Zn</span> <span class="op">~</span> <span class="va">log_dist2road</span>,</span>
<span>  <span class="va">moss</span>,</span>
<span>  spcov_type <span class="op">=</span> <span class="st">"exponential"</span>,</span>
<span>  random <span class="op">=</span> <span class="op">~</span> <span class="va">sample</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that <code>~ sample</code> is shorthand for
<code>(1 | sample)</code>, which is more explicit notation that
indicates random intercepts for each level of <code>sample</code>.</p>
<p>The second example adds a random intercept for <code>year</code>,
which creates extra correlation for observations within a year. It also
adds a random slope for <code>log_dist2road</code> within
<code>year</code>, which lets the effect of <code>log_dist2road</code>
vary between years. We fit this model by running</p>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rand2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/splm.html">splm</a></span><span class="op">(</span></span>
<span>  <span class="va">log_Zn</span> <span class="op">~</span> <span class="va">log_dist2road</span>,</span>
<span>  <span class="va">moss</span>,</span>
<span>  spcov_type <span class="op">=</span> <span class="st">"exponential"</span>,</span>
<span>  random <span class="op">=</span> <span class="op">~</span> <span class="va">sample</span> <span class="op">+</span> <span class="op">(</span><span class="va">log_dist2road</span> <span class="op">|</span> <span class="va">year</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that <code>sample + (log_dist2road | year)</code> is shorthand
for <code>(1 | sample) + (log_dist2road | year)</code>. If only random
slopes within a year are desired (and no random intercepts), a
<code>- 1</code> is given to the relevant portion of the formula:
<code>(log_dist2road - 1 | year)</code>. When there is more than one
term in <code>random</code>, each term must be surrounded by parentheses
(recall that the random intercept shorthand automatically includes
relevant parentheses). More examples of random effect syntax are
provided in the appendix.</p>
<p>We compare the AIC of the models by running</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/glances.html">glances</a></span><span class="op">(</span><span class="va">rand1</span>, <span class="va">rand2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 10</span></span></span>
<span><span class="co">#&gt;   model     n     p  npar value   AIC  AICc logLik deviance pseudo.r.squared</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> rand2   365     2     6  190.  202.  202.  -<span style="color: #BB0000;">94.9</span>     363.            0.215</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> rand1   365     2     4  335.  343.  343. -<span style="color: #BB0000;">168.</span>      363.            0.661</span></span></code></pre>
<p>The <code>rand2</code> model has the lowest AIC.</p>
<p>It is possible to fix random effect variances using the
<code>randcov_initial</code> argument, and <code>randcov_initial</code>
can also be used to set initial values for optimization.</p>
</div>
<div class="section level3">
<h3 id="partition-factors">Partition Factors<a class="anchor" aria-label="anchor" href="#partition-factors"></a>
</h3>
<p>A partition factor is a variable that allows observations to be
uncorrelated when they are from different levels of the partition
factor. Partition factors are specified in <code>spmodel</code> by
providing a formula with a single variable to the
<code>partition_factor</code> argument. Suppose that for the
<code>moss</code> data, we want observations in different years
(<code>year</code>) to be uncorrelated. We fit a model that treats year
as a partition factor by running</p>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">part</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/splm.html">splm</a></span><span class="op">(</span></span>
<span>  <span class="va">log_Zn</span> <span class="op">~</span> <span class="va">log_dist2road</span>,</span>
<span>  <span class="va">moss</span>,</span>
<span>  spcov_type <span class="op">=</span> <span class="st">"exponential"</span>,</span>
<span>  partition_factor <span class="op">=</span> <span class="op">~</span> <span class="va">year</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="sec:anisotropy">Anisotropy<a class="anchor" aria-label="anchor" href="#sec:anisotropy"></a>
</h3>
An isotroptic spatial covariance function (for point-referenced data)
behaves similarly in all directions (i.e., is independent of direction)
as a function of distance. An anisotropic covariance function does not
behave similarly in all directions as a function of distance. Consider
the spatial covariance imposed by an eastward-moving wind pattern. A
one-unit distance in the x-direction likely means something different
than a one-unit distance in the y-direction. Below are ellipses for an
isotropic and anisotropic covariance function centered at the origin (a
distance of zero).
<div class="figure">
<img src="guide_files/figure-html/anisotropy-1.png" alt="Ellipses for an isotropic (left) and anisotropic (right) covariance function centered at the origin. The black outline of each ellipse is a level curve of equal correlation." width="49%"><img src="guide_files/figure-html/anisotropy-2.png" alt="Ellipses for an isotropic (left) and anisotropic (right) covariance function centered at the origin. The black outline of each ellipse is a level curve of equal correlation." width="49%"><p class="caption">
Ellipses for an isotropic (left) and anisotropic (right) covariance
function centered at the origin. The black outline of each ellipse is a
level curve of equal correlation.
</p>
</div>
<p>The black outline of each ellipse is a level curve of equal
correlation. The left ellipse (a circle) represents an isotropic
covariance function. The distance at which the correlation between two
observations lays on the level curve is the same in all directions. The
right ellipse represents an anisotropic covariance function. The
distance at which the correlation between two observations lays on the
level curve is different in different directions.</p>
<p>Accounting for anisotropy involves a rotation and scaling of the
x-coordinates and y-coordinates such that the spatial covariance
function that uses these transformed distances is isotropic. We use the
<code>anisotropy</code> argument to <code><a href="../reference/splm.html">splm()</a></code> to fit a model
with anisotropy by running</p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spmod_anis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/splm.html">splm</a></span><span class="op">(</span></span>
<span>  <span class="va">log_Zn</span> <span class="op">~</span> <span class="va">log_dist2road</span>,</span>
<span>  <span class="va">moss</span>,</span>
<span>  spcov_type <span class="op">=</span> <span class="st">"exponential"</span>,</span>
<span>  anisotropy <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">spmod_anis</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; splm(formula = log_Zn ~ log_dist2road, data = moss, spcov_type = "exponential", </span></span>
<span><span class="co">#&gt;     anisotropy = TRUE)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -2.5279 -1.2239 -0.7202 -0.1921  1.1659 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients (fixed):</span></span>
<span><span class="co">#&gt;               Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span><span class="co">#&gt; (Intercept)    9.54798    0.22291   42.83   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; log_dist2road -0.54601    0.01855  -29.44   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Pseudo R-squared: 0.7048</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients (exponential spatial covariance):</span></span>
<span><span class="co">#&gt;        de        ie     range    rotate     scale </span></span>
<span><span class="co">#&gt; 3.561e-01 6.812e-02 8.732e+03 2.435e+00 4.753e-01 </span></span>
<span><span class="co">#&gt; attr(,"class")</span></span>
<span><span class="co">#&gt; [1] "exponential"</span></span></code></pre>
<p>The <code>rotate</code> parameter is between zero and <span class="math inline">\(\pi\)</span> radians and represents the angle of a
clockwise rotation of the ellipse such that the major axis of the
ellipse is the new x-axis and the minor axis of the ellipse is the new
y-axis. The <code>scale</code> parameter is between zero and one and
represents the ratio of the distance between the origin and the edge of
the ellipse along the minor axis to the distance between the origin and
the edge of the ellipse along the major axis. Below shows a
transformation that turns an anisotropic ellipse into an isotropic one
(i.e., a circle). This transformation requires rotating the coordinates
clockwise by <code>rotate</code> and then scaling them the reciprocal of
<code>scale</code>. The transformed coordinates are then used instead of
the original coordinates to compute distances and spatial
covariances.</p>
<div class="figure">
<img src="guide_files/figure-html/anisotropy_fit-1.png" alt="A visual representation of the anisotropy transformation. In the left figure, the first step is to rotate the anisotropic ellipse clockwise by the \texttt{rotate} parameter (here \texttt{rotate} is 0.75$\pi$ radians or 135 degrees). In the middle figure, the second step is to scale the y axis by the reciprocal of the \texttt{scale} parameter (here \texttt{scale} is 0.5). In the right figure, the anisotropic ellipse has been transformed into an isotropic one (i.e., a circle). The transformed coordinates are then used instead of the original coordinates to compute distances and spatial covariances." width="33%"><img src="guide_files/figure-html/anisotropy_fit-2.png" alt="A visual representation of the anisotropy transformation. In the left figure, the first step is to rotate the anisotropic ellipse clockwise by the \texttt{rotate} parameter (here \texttt{rotate} is 0.75$\pi$ radians or 135 degrees). In the middle figure, the second step is to scale the y axis by the reciprocal of the \texttt{scale} parameter (here \texttt{scale} is 0.5). In the right figure, the anisotropic ellipse has been transformed into an isotropic one (i.e., a circle). The transformed coordinates are then used instead of the original coordinates to compute distances and spatial covariances." width="33%"><img src="guide_files/figure-html/anisotropy_fit-3.png" alt="A visual representation of the anisotropy transformation. In the left figure, the first step is to rotate the anisotropic ellipse clockwise by the \texttt{rotate} parameter (here \texttt{rotate} is 0.75$\pi$ radians or 135 degrees). In the middle figure, the second step is to scale the y axis by the reciprocal of the \texttt{scale} parameter (here \texttt{scale} is 0.5). In the right figure, the anisotropic ellipse has been transformed into an isotropic one (i.e., a circle). The transformed coordinates are then used instead of the original coordinates to compute distances and spatial covariances." width="33%"><p class="caption">
A visual representation of the anisotropy transformation. In the left
figure, the first step is to rotate the anisotropic ellipse clockwise by
the parameter (here is 0.75<span class="math inline">\(\pi\)</span>
radians or 135 degrees). In the middle figure, the second step is to
scale the y axis by the reciprocal of the parameter (here is 0.5). In
the right figure, the anisotropic ellipse has been transformed into an
isotropic one (i.e., a circle). The transformed coordinates are then
used instead of the original coordinates to compute distances and
spatial covariances.
</p>
</div>
<p>Note that specifying an initial value for <code>rotate</code> that is
different from zero, specifying an initial value for <code>scale</code>
that is different from one, or assuming either <code>rotate</code> or
<code>scale</code> are unknown in <code>spcov_initial</code> will cause
<code><a href="../reference/splm.html">splm()</a></code> to fit a model with anisotropy (and will override
<code>anisotropy = FALSE</code>). Estimating anisotropy parameters is
only possible for maximum likelihood and restricted maximum likelihood
estimation, but fixed anisotropy parameters can be accommodated for
semivariogram weighted least squares or semivariogram composite
likelihood estimation. Also note that anisotropy is not relevant for
areal data because the spatial covariance function depends on a
neighborhood structure instead of distances between points.</p>
</div>
<div class="section level3">
<h3 id="sec:sim_data">Simulating Spatial Data<a class="anchor" aria-label="anchor" href="#sec:sim_data"></a>
</h3>
<p>The <code><a href="../reference/sprnorm.html">sprnorm()</a></code> function is used to simulate normal
(Gaussian) spatial data. To use <code><a href="../reference/sprnorm.html">sprnorm()</a></code>, the
<code><a href="../reference/spcov_params.html">spcov_params()</a></code> function is used to create an
<code>spcov_params</code> object. The <code><a href="../reference/spcov_params.html">spcov_params()</a></code>
function requires the spatial covariance type and parameter values. We
create an <code>spcov_params</code> object by running</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spcov_params.html">spcov_params</a></span><span class="op">(</span><span class="st">"exponential"</span>, de <span class="op">=</span> <span class="fl">5</span>, ie <span class="op">=</span> <span class="fl">1</span>, range <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p>We set a reproducible seed and then simulate data at 3000 random
locations in the unit square using the spatial covariance parameters in
<code>sim_params</code> by running</p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">3000</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">sim_coords</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="va">sim_response</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sprnorm.html">sprnorm</a></span><span class="op">(</span><span class="va">sim_params</span>, data <span class="op">=</span> <span class="va">sim_coords</span>, xcoord <span class="op">=</span> <span class="va">x</span>, ycoord <span class="op">=</span> <span class="va">y</span><span class="op">)</span></span>
<span><span class="va">sim_data</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="va">sim_coords</span>, <span class="va">sim_response</span><span class="op">)</span></span></code></pre></div>
<p>We can visualize the simulated data by running</p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sim_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">sim_response</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">7</span>, <span class="fl">7</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_gray</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span></span></code></pre></div>
<p>There is noticeable spatial patterning in the response variable
(<code>sim_response</code>). The default mean in <code><a href="../reference/sprnorm.html">sprnorm()</a></code>
is zero for all observations, though a mean vector can be provided using
the <code>mean</code> argument. The default number of samples generated
in <code><a href="../reference/sprnorm.html">sprnorm()</a></code> is one, though this can be changed using the
<code>samples</code> argument. Because <code>sim_data</code> is a
<code>tibble</code> (<code>data.frame</code>) and not an <code>sf</code>
object, the columns in <code>sim_data</code> representing the
x-coordinates and y-coordinates must be provided to
<code><a href="../reference/sprnorm.html">sprnorm()</a></code>.</p>
<p>Note that the output from <code>coef(object, type = "spcov")</code>
is a <code>spcov_params</code> object. This is useful if we want to
simulate data given the estimated spatial covariance parameters from a
fitted model. Random effects are incorporated into simulation via the
<code>randcov_params</code> argument.</p>
</div>
<div class="section level3">
<h3 id="big-data">Big Data<a class="anchor" aria-label="anchor" href="#big-data"></a>
</h3>
<p>The computational cost associated with model fitting is exponential
in the sample size for all estimation methods. For maximum likelihood
and restricted maximum likelihood, the computational cost of estimating
<span class="math inline">\(\boldsymbol{\theta}\)</span> is cubic. For
semivariogram weighted least squares and semivariogram composite
likelihood, the computational cost of estimating <span class="math inline">\(\boldsymbol{\theta}\)</span> is quadratic. The
computational cost associated with estimating <span class="math inline">\(\boldsymbol{\beta}\)</span> and prediction is
cubic, regardless of estimation method. Typically, samples sizes
approaching 10,000 make the computational cost of model fitting and
prediction infeasible, which necessitates the use of big data methods.
<code>spmodel</code> offers big data methods for model fitting of
point-referenced data via the <code>local</code> argument to
<code><a href="../reference/splm.html">splm()</a></code>. The method is capable of quickly fitting models
with hundreds of thousands of observations. Because of the neighborhood
structure of areal data, the big data methods used for point-referenced
data do not apply to areal data. Thus, there is no big data method for
areal data or <code>local</code> argument to <code><a href="../reference/spautor.html">spautor()</a></code>, so
model fitting sample sizes cannot be too large</p>
<p><code>spmodel</code> offers big data methods for prediction of
point-referenced data or areal data via the <code>local</code> argument
to <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>. This method is capable of quickly predicting
hundreds of thousands of observations. To show how to use
<code>spmodel</code> for big data estimation and prediction, we use the
<code>sim_data</code> data from the previous section. Because
<code>sim_data</code> is a <code>tibble</code> (<code>data.frame</code>)
and not an <code>sf</code> object, the columns in <code>data</code>
representing the x-coordinates and y-coordinates must be explicitly
provided to <code><a href="../reference/splm.html">splm()</a></code>.</p>
<p>Next we briefly discuss model fitting and prediction for big data in
<code>spmodel</code>, but further details are provided by <span class="citation">Ver Hoef, Dumelle, et al. (2023)</span>.</p>
<div class="section level4">
<h4 id="sec:modelfit-big">Model Fitting<a class="anchor" aria-label="anchor" href="#sec:modelfit-big"></a>
</h4>
<p><code>spmodel</code> uses a “local spatial indexing” (SPIN) approach
for big data model fitting of point-referenced data. Observations are
first assigned an index. Then for the purposes of model fitting,
observations with different indexes are assumed uncorrelated. Assuming
observations with different indexes are uncorrelated induces sparsity in
the covariance matrix, which greatly reduces the computational time of
operations that involve the covariance matrix.</p>
<p>The <code>local</code> argument to <code><a href="../reference/splm.html">splm()</a></code> controls the
big data options. <code>local</code> is a list with several arguments.
The arguments to the <code>local</code> list control the method used to
assign the indexes, the number of observations with the same index, the
number of unique indexes, variance adjustments to the covariance matrix
of <span class="math inline">\(\hat{\boldsymbol{\beta}}\)</span>,
whether or not to use parallel processing, and if parallel processing is
used, the number of cores.</p>
<p>Big data are most simply accommodated by setting <code>local</code>
to <code>TRUE</code>. This is shorthand for</p>
<p><code>local = list(method = "kmeans", size = 100, var_adjust = "theoretical", parallel = FALSE)</code>,</p>
<p>which assigns observations to index groups based on k-means
clustering <span class="citation">(MacQueen 1967)</span>, ensures each
index group has approximately 100 observations, uses the
theoretically-correct variance adjustment, and does not use parallel
processing.</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">local1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/splm.html">splm</a></span><span class="op">(</span><span class="va">sim_response</span> <span class="op">~</span> <span class="fl">1</span>, <span class="va">sim_data</span>, spcov_type <span class="op">=</span> <span class="st">"exponential"</span>, </span>
<span>               xcoord <span class="op">=</span> <span class="va">x</span>, ycoord <span class="op">=</span> <span class="va">y</span>, local <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">local1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; splm(formula = sim_response ~ 1, data = sim_data, spcov_type = "exponential", </span></span>
<span><span class="co">#&gt;     xcoord = x, ycoord = y, local = TRUE)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -4.9414 -1.2573 -0.0527  1.3783  6.6322 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients (fixed):</span></span>
<span><span class="co">#&gt;             Estimate Std. Error z value Pr(&gt;|z|)  </span></span>
<span><span class="co">#&gt; (Intercept)  -1.1149     0.6416  -1.738   0.0823 .</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients (exponential spatial covariance):</span></span>
<span><span class="co">#&gt;     de     ie  range </span></span>
<span><span class="co">#&gt; 2.3112 1.0260 0.2395</span></span></code></pre>
<p>Instead of using <code>local = TRUE</code>, we can explicitly set
<code>local</code>. For example, we can fit a model using random
assignment with 60 groups, use the pooled variance adjustment, and use
parallel processing with two cores by running</p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">local2_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"random"</span>, groups <span class="op">=</span> <span class="fl">60</span>, var_adjust <span class="op">=</span> <span class="st">"pooled"</span>,</span>
<span>                    parallel <span class="op">=</span> <span class="cn">TRUE</span>, ncores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">local2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/splm.html">splm</a></span><span class="op">(</span><span class="va">sim_response</span> <span class="op">~</span> <span class="fl">1</span>, <span class="va">sim_data</span>, spcov_type <span class="op">=</span> <span class="st">"exponential"</span>, </span>
<span>               xcoord <span class="op">=</span> <span class="va">x</span>, ycoord <span class="op">=</span> <span class="va">y</span>, local <span class="op">=</span> <span class="va">local2_list</span><span class="op">)</span></span></code></pre></div>
<p>Likelihood-based statistics like <code><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC()</a></code>,
<code><a href="../reference/AIC.spmodel.html">AICc()</a></code>, <code><a href="https://rdrr.io/r/stats/logLik.html" class="external-link">logLik()</a></code>, and <code><a href="https://rdrr.io/r/stats/deviance.html" class="external-link">deviance()</a></code>
should not be used to compare a model fit with a big data approximation
to a model fit without a big data approximation.</p>
</div>
<div class="section level4">
<h4 id="sec:prediction-big">Prediction<a class="anchor" aria-label="anchor" href="#sec:prediction-big"></a>
</h4>
<p>For point-referenced data, <code>spmodel</code> uses a “local
neighborhood” approach for big data prediction. Each prediction is
computed using a subset of the observed data instead of all of the
observed data. Before further discussing big data prediction, we
simulate 1000 locations in the unit square requiring prediction:</p>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_pred</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_pred</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_pred</span><span class="op">)</span></span>
<span><span class="va">sim_preds</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span></span></code></pre></div>
<p>The <code>local</code> argument to <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> controls
the big data options. <code>local</code> is a list with several
arguments. The arguments to the <code>local</code> list control the
method used to subset the observed data, the number of observations in
each subset, whether or not to use parallel processing, and if parallel
processing is used, the number of cores.</p>
<p>The simplest way to accommodate big data prediction is to set
<code>local</code> to <code>TRUE</code>. This is shorthand for
<code>local = list(method = "covariance", size = 100, parallel = FALSE)</code>,
which implies that, for each location requiring prediction, only the 100
observations in the data most correlated with it are used in the
computation and parallel processing is not used. Using the
<code>local1</code> fitted model, we store these predictions as a
variable called <code>preds</code> in the <code>sim_preds</code> data by
running</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_preds</span><span class="op">$</span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">local1</span>, newdata <span class="op">=</span> <span class="va">sim_preds</span>, local <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The predictions are visualized by running</p>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sim_preds</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">preds</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">7</span>, <span class="fl">7</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_gray</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span></span></code></pre></div>
<p>They display a similar pattern as the observed data.</p>
<div class="figure" style="text-align: center">
<img src="guide_files/figure-html/sim_preds-1.png" alt="Observed data and big data predictions at unobserved locations. In the left figure, spatial data are simulated in the unit square. A spatial linear model is fit using the default big data approximation for model-fitting. In the right figure, predictions are made using the fitted model and the default big data approximation for prediction." width="49%"><img src="guide_files/figure-html/sim_preds-2.png" alt="Observed data and big data predictions at unobserved locations. In the left figure, spatial data are simulated in the unit square. A spatial linear model is fit using the default big data approximation for model-fitting. In the right figure, predictions are made using the fitted model and the default big data approximation for prediction." width="49%"><p class="caption">
Observed data and big data predictions at unobserved locations. In the
left figure, spatial data are simulated in the unit square. A spatial
linear model is fit using the default big data approximation for
model-fitting. In the right figure, predictions are made using the
fitted model and the default big data approximation for prediction.
</p>
</div>
<p>Instead of using <code>local = TRUE</code>, we can explicitly set
<code>local</code>:</p>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"distance"</span>, size <span class="op">=</span> <span class="fl">30</span>, parallel <span class="op">=</span> <span class="cn">TRUE</span>, ncores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">local1</span>, newdata <span class="op">=</span> <span class="va">sim_preds</span>, local <span class="op">=</span> <span class="va">pred_list</span><span class="op">)</span></span></code></pre></div>
<p>This code implies that uniquely for each location requiring
prediction, only the 30 observations in the data closest to it (in terms
of Euclidean distance) are used in the computation and parallel
processing is used with two cores.</p>
<p>For areal data, no local neighborhood approximation exists because of
the data’s underlying neighborhood structure. Thus, all of the data must
be used to compute predictions, and by consequence, <code>method</code>
and <code>size</code> are not components of the <code>local</code> list.
The only components of the <code>local</code> list for areal data are
<code>parallel</code> and <code>ncores</code>.</p>
</div>
</div>
<div class="section level3">
<h3 id="sec:rf">Random Forest Spatial Residual Models<a class="anchor" aria-label="anchor" href="#sec:rf"></a>
</h3>
<p>Random forest spatial residual models are used for prediction. They
combine aspects of random forest prediction and spatial linear model
prediction, which can lead to significant improvements in predictive
accuracy compared to standard random forest prediction <span class="citation">(Fox, Ver Hoef, and Olsen 2020)</span>. To fit a random
forest spatial residual model, use <code><a href="../reference/splmRF.html">splmRF()</a></code> (for
point-referenced data) or <code><a href="../reference/spautorRF.html">spautorRF()</a></code> (for areal data).
These functions require at least one explanatory variable be specified,
so we add an explanatory variable called <code>var</code> to
<code>sulfate</code> and <code>sulfate_preds</code> for illustrative
purposes.</p>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sulfate</span><span class="op">$</span><span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">sulfate</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sulfate_preds</span><span class="op">$</span><span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">sulfate_preds</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Then we fit a random forest spatial residual model by running</p>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sprfmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/splmRF.html">splmRF</a></span><span class="op">(</span><span class="va">sulfate</span> <span class="op">~</span> <span class="va">var</span>, <span class="va">sulfate</span>, spcov_type <span class="op">=</span> <span class="st">"exponential"</span><span class="op">)</span></span></code></pre></div>
<p>And we make predictions by running</p>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">sprfmod</span>, newdata <span class="op">=</span> <span class="va">sulfate_preds</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="sec:spglm">Spatial Generalized Linear Models<a class="anchor" aria-label="anchor" href="#sec:spglm"></a>
</h3>
<p>When building spatial linear models, the response vector <span class="math inline">\(\mathbf{y}\)</span> is typically assumed Gaussian
(given <span class="math inline">\(\mathbf{X}\)</span>). Relaxing this
assumption on the distribution of <span class="math inline">\(\mathbf{y}\)</span> yields a rich class of spatial
generalized linear models that can describe binary data, proportion
data, count data, and skewed data that is parameterized as <span class="math display">\[
g(\boldsymbol{\mu}) = \boldsymbol{\eta} = \mathbf{X} \boldsymbol{\beta}
+ \boldsymbol{\tau} + \boldsymbol{\epsilon},
\]</span> where <span class="math inline">\(g(\cdot)\)</span> is called
a link function, <span class="math inline">\(\boldsymbol{\mu}\)</span>
is the mean of <span class="math inline">\(\mathbf{y}\)</span>, and the
remaining terms <span class="math inline">\(\mathbf{X}\)</span>, <span class="math inline">\(\boldsymbol{\beta}\)</span>, <span class="math inline">\(\boldsymbol{\tau}\)</span>, <span class="math inline">\(\boldsymbol{\epsilon}\)</span> represent the same
quantities as for the spatial linear models. The link function, <span class="math inline">\(g(\cdot)\)</span>, “links” a function of <span class="math inline">\(\boldsymbol{\mu}\)</span> to the linear term <span class="math inline">\(\boldsymbol{\eta}\)</span> , denoted here as <span class="math inline">\(\mathbf{X} \boldsymbol{\beta} + \boldsymbol{\tau}
+ \boldsymbol{\epsilon}\)</span>, which is familiar from spatial linear
models. Note that the linking of <span class="math inline">\(\boldsymbol{\mu}\)</span> to <span class="math inline">\(\boldsymbol{\eta}\)</span> applies element-wise to
each vector. Each link function <span class="math inline">\(g(\cdot)\)</span> has a corresponding inverse link
function, <span class="math inline">\(g^{-1}(\cdot)\)</span>. The
inverse link function “links” a function of <span class="math inline">\(\boldsymbol{\eta}\)</span> to <span class="math inline">\(\boldsymbol{\mu}\)</span>. Notice that for spatial
generalized linear models, we are not modeling <span class="math inline">\(\mathbf{y}\)</span> directly as we do for spatial
linear models, but rather we are modeling a function of the mean of
<span class="math inline">\(\mathbf{y}\)</span>. Also notice that <span class="math inline">\(\boldsymbol{\eta}\)</span> is unconstrained but
<span class="math inline">\(\boldsymbol{\mu}\)</span> is usually
constrained in some way (e.g., positive).</p>
<p>The model <span class="math inline">\(g(\boldsymbol{\mu}) =
\boldsymbol{\eta} = \mathbf{X} \boldsymbol{\beta} + \boldsymbol{\tau} +
\boldsymbol{\epsilon}\)</span> is called the spatial generalized linear
model. <code>spmodel</code> allows fitting of spatial generalized linear
models when <span class="math inline">\(\mathbf{y}\)</span> is a
binomial (or Bernoulli), beta, Poisson, negative binomial, gamma, or
inverse Gaussian random vector via the Laplace approximation and
restricted maximum likelihood estimation or maximum likelihood
estimation – <span class="citation">Ver Hoef, Blagg, et al.
(2023)</span> provide further details. For binomial and beta <span class="math inline">\(\mathbf{y}\)</span>, the logit link function is
defined as <span class="math inline">\(g(\boldsymbol{\mu}) =
\ln(\frac{\boldsymbol{\mu}}{1 - \boldsymbol{\mu}}) =
\boldsymbol{\eta}\)</span>, and the inverse logit link function is
defined as <span class="math inline">\(g^{-1}(\boldsymbol{\eta}) =
\frac{\exp(\boldsymbol{\eta})}{1 + \exp(\boldsymbol{\eta})} =
\boldsymbol{\mu}\)</span>. For Poisson, negative binomial, gamma, and
inverse Gaussian <span class="math inline">\(\mathbf{y}\)</span>, the
log link function is defined as <span class="math inline">\(g(\boldsymbol{\mu}) = \ln(\boldsymbol{\mu}) =
\boldsymbol{\eta}\)</span>, and the inverse log link function is defined
as <span class="math inline">\(g^{-1}(\boldsymbol{\eta}) =
\exp(\boldsymbol{\eta}) = \boldsymbol{\mu}\)</span>. Full
parameterizations of these distributions are given in the technical
details vignette, which can be viewed by running
<code><a href="../articles/technical.html">vignette("technical", "spmodel")</a></code>.</p>
<p>All advanced features available in <code>spmodel</code> for spatial
linear models are also available for spatial generalized linear models.
This means that spatial generalized linear models in
<code>spmodel</code> can accommodate fixing spatial covariance
parameters, fitting and predicting for multiple models, random effects
(on the link scale), partition factors, anisotropy (on the link scale),
simulation, big data, and prediction.</p>
<div class="section level4">
<h4 id="sec:modelfit-glm">Model Fitting<a class="anchor" aria-label="anchor" href="#sec:modelfit-glm"></a>
</h4>
<p>As with spatial linear models, spatial generalized linear models are
fit in <code>spmodel</code> for point-referenced and areal data. The
<code><a href="../reference/spglm.html">spglm()</a></code> function is used to fit spatial generalized linear
models for point-referenced data, and the <code><a href="../reference/spgautor.html">spgautor()</a></code>
function is used to fit spatial generalized linear models for areal
data. <code><a href="../reference/spglm.html">spglm()</a></code> and <code><a href="../reference/spgautor.html">spgautor()</a></code> share similar
syntax with <code><a href="../reference/splm.html">splm()</a></code> and <code><a href="../reference/spautor.html">spautor()</a></code>,
respectively, though one additional argument is required:</p>
<ul>
<li>
<code>family</code>: the generalized linear model family (i.e., the
distribution of <span class="math inline">\(\mathbf{y}\)</span>).
<code>family</code> can be <code>binomial</code>, <code>beta</code>,
<code>poisson</code>, <code>nbinomial</code>, <code>Gamma</code>, or
<code>inverse.gaussian</code>.</li>
<li>
<code>family</code> uses similar syntax as the <code>family</code>
argument in <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code>.</li>
<li>One difference between <code>family</code> in <code><a href="../reference/spglm.html">spglm()</a></code>
compared to <code>family</code> in <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code> is that the link
function is fixed in <code><a href="../reference/spglm.html">spglm()</a></code>.</li>
</ul>
<p>As with <code><a href="../reference/splm.html">splm()</a></code> and <code><a href="../reference/spautor.html">spautor()</a></code>, the data
argument to <code><a href="../reference/spglm.html">spglm()</a></code> and <code><a href="../reference/spgautor.html">spgautor()</a></code> can be an
<code>sf</code> object or <code>data.frame</code> (with appropriate
coordinate or weight matrix information). Additionally, all arguments to
<code><a href="../reference/splm.html">splm()</a></code> and <code><a href="../reference/spautor.html">spautor()</a></code> are also available for
<code><a href="../reference/spglm.html">spglm()</a></code> and <code><a href="../reference/spgautor.html">spgautor()</a></code>.</p>
<p>Next we show the basic features and syntax of <code><a href="../reference/spglm.html">spglm()</a></code>
using the <code>moose</code> data. We study the impact of elevation
(<code>elev</code>) on the presence of moose (<code>presence</code>)
observed at a site location in Alaska. <code>presence</code> equals one
if at least one moose was observed at the site and zero otherwise. We
view the first few rows of the <code>moose</code> data by running</p>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">moose</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Simple feature collection with 218 features and 4 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 269085 ymin: 1416151 xmax: 419976.2 ymax: 1541763</span></span>
<span><span class="co">#&gt; Projected CRS: NAD83 / Alaska Albers</span></span>
<span><span class="co">#&gt; First 10 features:</span></span>
<span><span class="co">#&gt;        elev strat count presence                 geometry</span></span>
<span><span class="co">#&gt; 1  468.9167     L     0        0 POINT (293542.6 1541016)</span></span>
<span><span class="co">#&gt; 2  362.3125     L     0        0 POINT (298313.1 1533972)</span></span>
<span><span class="co">#&gt; 3  172.7500     M     0        0 POINT (281896.4 1532516)</span></span>
<span><span class="co">#&gt; 4  279.6250     L     0        0 POINT (298651.3 1530264)</span></span>
<span><span class="co">#&gt; 5  619.6000     L     0        0 POINT (311325.3 1527705)</span></span>
<span><span class="co">#&gt; 6  164.1250     M     0        0 POINT (291421.5 1518398)</span></span>
<span><span class="co">#&gt; 7  163.5000     M     0        0 POINT (287298.3 1518035)</span></span>
<span><span class="co">#&gt; 8  186.3500     L     0        0 POINT (279050.9 1517324)</span></span>
<span><span class="co">#&gt; 9  362.3125     L     0        0 POINT (346145.9 1512479)</span></span>
<span><span class="co">#&gt; 10 430.5000     L     0        0 POINT (321354.6 1509966)</span></span></code></pre>
<p>We can visualize the distribution of moose presence
(<code>presence</code>) by running</p>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">moose</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">presence</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_d</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"H"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_gray</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="guide_files/figure-html/moose-1.png" alt="Distribution of moose presence in Alaska. presence equals one if at least one moose was observed at the site and zero otherwise." width="65%"><p class="caption">
Distribution of moose presence in Alaska. presence equals one if at
least one moose was observed at the site and zero otherwise.
</p>
</div>
<p>One example of a generalized linear model is a binomial (e.g.,
logistic) regression model. Binomial regression models are often used to
model presence data such as these. To quantify the relationship between
moose presence and elevation, we fit a spatial binomial regression model
(a specific spatial generalized linear model) by running</p>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">binmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spglm.html">spglm</a></span><span class="op">(</span><span class="va">presence</span> <span class="op">~</span> <span class="va">elev</span>, family <span class="op">=</span> <span class="st">"binomial"</span>,</span>
<span>                data  <span class="op">=</span> <span class="va">moose</span>, spcov_type <span class="op">=</span> <span class="st">"exponential"</span><span class="op">)</span></span></code></pre></div>
<p>The estimation method is specified via the <code>estmethod</code>
argument, which has a default value of <code>"reml"</code> for
restricted maximum likelihood. The other estimation method is
<code>"ml"</code> for maximum likelihood.</p>
<p>We summarize the fitted model by running</p>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">binmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; spglm(formula = presence ~ elev, family = "binomial", data = moose, </span></span>
<span><span class="co">#&gt;     spcov_type = "exponential")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Deviance Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -1.5249 -0.8114  0.5600  0.8306  1.5757 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients (fixed):</span></span>
<span><span class="co">#&gt;              Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span><span class="co">#&gt; (Intercept) -0.874038   1.140953  -0.766    0.444</span></span>
<span><span class="co">#&gt; elev         0.002365   0.003184   0.743    0.458</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Pseudo R-squared: 0.00311</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients (exponential spatial covariance):</span></span>
<span><span class="co">#&gt;        de        ie     range </span></span>
<span><span class="co">#&gt; 3.746e+00 4.392e-03 3.203e+04 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients (Dispersion for binomial family):</span></span>
<span><span class="co">#&gt; dispersion </span></span>
<span><span class="co">#&gt;          1</span></span></code></pre>
<p>Similar to summaries of <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code> objects, summaries of
<code><a href="../reference/spglm.html">spglm()</a></code> objects include the original function call, summary
statistics of the deviance residuals, and a coefficients table of fixed
effects. The logit of moose presence probability does not appear to be
related to elevation, as evidenced by the large p-value associated with
the asymptotic z-test. A pseudo r-squared is also returned, which
quantifies the proportion of variability explained by the fixed effects.
The spatial covariance parameters and dispersion parameter are also
returned. The dispersion parameter is estimated in some spatial
generalized linear models and changes the mean-variance relationship of
<span class="math inline">\(\mathbf{y}\)</span>. For binomial regression
models, the dispersion parameter is not estimated and is always fixed at
one.</p>
<p>We tidy, glance, and augment the fitted model by running</p>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">binmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 5</span></span></span>
<span><span class="co">#&gt;   term        estimate std.error statistic p.value</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> (Intercept) -<span style="color: #BB0000;">0.874</span>     1.14       -<span style="color: #BB0000;">0.766</span>   0.444</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> elev         0.002<span style="text-decoration: underline;">37</span>   0.003<span style="text-decoration: underline;">18</span>     0.743   0.458</span></span></code></pre>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/glance.html" class="external-link">glance</a></span><span class="op">(</span><span class="va">binmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 9</span></span></span>
<span><span class="co">#&gt;       n     p  npar value   AIC  AICc logLik deviance pseudo.r.squared</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>   218     2     3  692.  698.  698.  -<span style="color: #BB0000;">346.</span>     190.          0.003<span style="text-decoration: underline;">11</span></span></span></code></pre>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="va">binmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Simple feature collection with 218 features and 7 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 269085 ymin: 1416151 xmax: 419057.4 ymax: 1541016</span></span>
<span><span class="co">#&gt; Projected CRS: NAD83 / Alaska Albers</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 218 × 8</span></span></span>
<span><span class="co">#&gt;    presence  elev .fitted .resid    .hat  .cooksd .std.resid</span></span>
<span><span class="co">#&gt;  <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 0         469.  0.150  -<span style="color: #BB0000;">0.571</span> 0.050<span style="text-decoration: underline;">0</span>  0.009<span style="text-decoration: underline;">04</span>      -<span style="color: #BB0000;">0.586</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 0         362.  0.107  -<span style="color: #BB0000;">0.477</span> 0.016<span style="text-decoration: underline;">8</span>  0.001<span style="text-decoration: underline;">98</span>      -<span style="color: #BB0000;">0.481</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 0         173.  0.104  -<span style="color: #BB0000;">0.468</span> 0.002<span style="text-decoration: underline;">13</span> 0.000<span style="text-decoration: underline;">235</span>     -<span style="color: #BB0000;">0.469</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 0         280.  0.093<span style="text-decoration: underline;">9</span> -<span style="color: #BB0000;">0.444</span> 0.006<span style="text-decoration: underline;">16</span> 0.000<span style="text-decoration: underline;">615</span>     -<span style="color: #BB0000;">0.445</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 0         620.  0.198  -<span style="color: #BB0000;">0.664</span> 0.136   0.040<span style="text-decoration: underline;">2</span>       -<span style="color: #BB0000;">0.714</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 0         164.  0.130  -<span style="color: #BB0000;">0.528</span> 0.002<span style="text-decoration: underline;">60</span> 0.000<span style="text-decoration: underline;">364</span>     -<span style="color: #BB0000;">0.528</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 0         164.  0.135  -<span style="color: #BB0000;">0.538</span> 0.002<span style="text-decoration: underline;">69</span> 0.000<span style="text-decoration: underline;">392</span>     -<span style="color: #BB0000;">0.539</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 0         186.  0.166  -<span style="color: #BB0000;">0.603</span> 0.003<span style="text-decoration: underline;">32</span> 0.000<span style="text-decoration: underline;">607</span>     -<span style="color: #BB0000;">0.604</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 0         362.  0.168  -<span style="color: #BB0000;">0.606</span> 0.024<span style="text-decoration: underline;">5</span>  0.004<span style="text-decoration: underline;">74</span>      -<span style="color: #BB0000;">0.614</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 0         430.  0.225  -<span style="color: #BB0000;">0.714</span> 0.052<span style="text-decoration: underline;">8</span>  0.015<span style="text-decoration: underline;">0</span>       -<span style="color: #BB0000;">0.734</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 208 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: geometry &lt;POINT [m]&gt;</span></span></span></code></pre>
</div>
<div class="section level4">
<h4 id="sec:predict-glm">Prediction<a class="anchor" aria-label="anchor" href="#sec:predict-glm"></a>
</h4>
<p>For spatial generalized linear models, we are predicting the mean of
the process generating the observation (which includes the spatial
effects) rather than the observation itself. We make predictions of
moose presence probability at the locations in <code>moose_preds</code>
by running</p>
<div class="sourceCode" id="cb125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">moose_preds</span><span class="op">$</span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">binmod</span>, newdata <span class="op">=</span> <span class="va">moose_preds</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span></code></pre></div>
<p>The type argument specifies whether predictions are returned on the
link or response (inverse link) scale.</p>
<p>We visualize these predictions by running</p>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">moose_preds</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">preds</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, option <span class="op">=</span> <span class="st">"H"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_gray</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="guide_files/figure-html/moose-pred-1.png" alt="Distribution of moose presence probability predictions in Alaska." width="65%"><p class="caption">
Distribution of moose presence probability predictions in Alaska.
</p>
</div>
<p>These predictions have similar spatial patterns as moose presence the
observed data. Next we remove the model predictions from
<code>moose_preds</code> and show how <code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code> can be used
to obtain the same predictions alongside prediction intervals (on the
response scale):</p>
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">moose_preds</span><span class="op">$</span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="va">binmod</span>, newdata <span class="op">=</span> <span class="va">moose_preds</span>, type <span class="op">=</span> <span class="st">"response"</span>, interval <span class="op">=</span> <span class="st">"prediction"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Simple feature collection with 100 features and 5 fields</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 269386.2 ymin: 1418453 xmax: 419976.2 ymax: 1541763</span></span>
<span><span class="co">#&gt; Projected CRS: NAD83 / Alaska Albers</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 100 × 6</span></span></span>
<span><span class="co">#&gt;     elev strat .fitted .lower .upper           geometry</span></span>
<span><span class="co">#&gt;  <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;POINT [m]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  143. L       0.705 0.248   0.946 (401239.6 1436192)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  324. L       0.336 0.037<span style="text-decoration: underline;">3</span>  0.868 (352640.6 1490695)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  158. L       0.263 0.032<span style="text-decoration: underline;">1</span>  0.792 (360954.9 1491590)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  221. M       0.243 0.036<span style="text-decoration: underline;">0</span>  0.734 (291839.8 1466091)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  209. M       0.742 0.270   0.957 (310991.9 1441630)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  218. L       0.191 0.019<span style="text-decoration: underline;">6</span>  0.736 (304473.8 1512103)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  127. L       0.179 0.022<span style="text-decoration: underline;">6</span>  0.673 (339011.1 1459318)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  122. L       0.241 0.034<span style="text-decoration: underline;">4</span>  0.738 (342827.3 1463452)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  191  L       0.386 0.041<span style="text-decoration: underline;">4</span>  0.902 (284453.8 1502837)</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  105. L       0.494 0.114   0.882 (391343.9 1483791)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 90 more rows</span></span></span></code></pre>
</div>
<div class="section level4">
<h4 id="sec:sim_data-glm">Simulating Spatial Generalized Data<a class="anchor" aria-label="anchor" href="#sec:sim_data-glm"></a>
</h4>
<p>Several functions exist to simulate spatial generalized data:
<code><a href="../reference/sprbinom.html">sprbinom()</a></code> for binomial random variables;
<code><a href="../reference/sprbeta.html">sprbeta()</a></code> for beta random variables; <code><a href="../reference/sprpois.html">sprpois()</a></code>
for Poisson random variables; <code><a href="../reference/sprnbinom.html">sprnbinom()</a></code> for negative
binomial random variables; <code><a href="../reference/sprgamma.html">sprgamma()</a></code> for gamma random
variables; and <code>spinvgauss()</code> for inverse Gaussian random
variables. All of these functions share similar syntax with
<code><a href="../reference/sprnorm.html">sprnorm()</a></code> for simulating spatial Gaussian data and require
a <code><a href="../reference/spcov_params.html">spcov_params()</a></code> object. The generalized data simulation
functions work by first simulating spatial Gaussian data on the link
scale. Then this realization is used as the mean by which to simulate
the spatial generalized linear model data.</p>
<p>We recreate <code>sim_params</code> and <code>sim_data</code> by
running</p>
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spcov_params.html">spcov_params</a></span><span class="op">(</span><span class="st">"exponential"</span>, de <span class="op">=</span> <span class="fl">5</span>, ie <span class="op">=</span> <span class="fl">1</span>, range <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">3000</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">sim_coords</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span></code></pre></div>
<p>We simulate a Bernoulli (binomial with size one) random variable by
running</p>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_response</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sprbinom.html">sprbinom</a></span><span class="op">(</span><span class="va">sim_params</span>, data <span class="op">=</span> <span class="va">sim_coords</span>, xcoord <span class="op">=</span> <span class="va">x</span>, ycoord <span class="op">=</span> <span class="va">y</span><span class="op">)</span></span>
<span><span class="va">sim_data</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="va">sim_coords</span>, sim_response <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">sim_response</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>and visualize it by running</p>
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sim_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">sim_response</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_d</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"H"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_gray</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="guide_files/figure-html/sim-glm-1.png" alt="Spatial binomial data simulated in the unit square." width="65%"><p class="caption">
Spatial binomial data simulated in the unit square.
</p>
</div>
<p>There is noticeable patterning in the response variable
(<code>sim_response</code>) in the same places where there is noticeable
patterning for the spatial Gaussian data. This is expected, as the
spatial Gaussian data are used to inform the mean (proportion) parameter
of the binomial data. Thus where the mean (proportion) parameter is
higher, the more likely the binomial observation takes on the value one
(successes are usually coded as a one).</p>
</div>
<div class="section level4">
<h4 id="additional-examples">Additional Examples<a class="anchor" aria-label="anchor" href="#additional-examples"></a>
</h4>
<p>We previously showed how to use <code>spmodel</code> to model binary
data via spatial binomial regression. Recall that <code>spmodel</code>
can also be used to model count data via spatial Poisson regression or
spatial negative binomial regression, proportion data via spatial beta
regression, and skewed, positive data via spatial gamma regression or
spatial inverse Gaussian regression. Next we provide examples of fitting
a few of these models.</p>
<p>Poisson regression is used to model count data. To quantify the
relationship between moose counts (<code>count</code>) and elevation, we
fit a spatial Poisson regression model and make predictions by
running</p>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">poismod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spglm.html">spglm</a></span><span class="op">(</span><span class="va">count</span> <span class="op">~</span> <span class="va">elev</span>, family <span class="op">=</span> <span class="st">"poisson"</span>,</span>
<span>                 data <span class="op">=</span> <span class="va">moose</span>, spcov_type <span class="op">=</span> <span class="st">"exponential"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">poismod</span>, newdata <span class="op">=</span> <span class="va">moose_preds</span><span class="op">)</span></span></code></pre></div>
<p>Poisson regression assumes the mean and variance are equal. Often in
practice, the variance is larger than the mean. When the variance is
larger than the mean, there is said to be overdispersion in the data.
Negative binomial regression accounts for overdispersion via an extra
dispersion parameter that allows the variance to change separately from
the mean (recall the full negative binomial regression parameterization
is available in the technical details vignette). We fit a spatial
negative binomial regression model to the moose count data and make
predictions by running</p>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nbmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spglm.html">spglm</a></span><span class="op">(</span><span class="va">count</span> <span class="op">~</span> <span class="va">elev</span>, family <span class="op">=</span> <span class="st">"nbinomial"</span>,</span>
<span>               data <span class="op">=</span> <span class="va">moose</span>, spcov_type <span class="op">=</span> <span class="st">"exponential"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">nbmod</span>, newdata <span class="op">=</span> <span class="va">moose_preds</span><span class="op">)</span></span></code></pre></div>
<p>Gamma regression is used to model skewed, positive data. Suppose
instead of modeling the <code>sulfate</code> data using a spatial linear
model, we modeled sulfate using spatial gamma regression. We fit a
spatial gamma regression model to the sulfate data and make predictions
by running</p>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gammamod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spglm.html">spglm</a></span><span class="op">(</span><span class="va">sulfate</span> <span class="op">~</span> <span class="fl">1</span>, family <span class="op">=</span> <span class="st">"Gamma"</span>,</span>
<span>                  data <span class="op">=</span> <span class="va">sulfate</span>, spcov_type <span class="op">=</span> <span class="st">"exponential"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">gammamod</span>, newdata <span class="op">=</span> <span class="va">sulfate_preds</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="sec:discussion">Discussion<a class="anchor" aria-label="anchor" href="#sec:discussion"></a>
</h2>
<p>Throughout this vignette, we have shown how to use
<code>spmodel</code> to fit, summarize, and predict for a variety of
spatial statistical models. Spatial linear models for point-referenced
data (i.e., geostatistical models) are fit using the <code><a href="../reference/splm.html">splm()</a></code>
function while spatial linear models for areal data (i.e., spatial
autoregressive models) are fit using the <code><a href="../reference/spautor.html">spautor()</a></code>
function. Spatial generalized linear models for point-referenced data
(i.e., generalized geostatistical models) are fit using the
<code><a href="../reference/spglm.html">spglm()</a></code> function while spatial generalized linear models
for areal data (i.e., spatial generalized autoregressive models) are fit
using the <code><a href="../reference/spgautor.html">spgautor()</a></code> function. Several model-fit statistics
and diagnostics are available. The broom functions <code><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy()</a></code>
and <code><a href="https://generics.r-lib.org/reference/glance.html" class="external-link">glance()</a></code> are used to tidy and glance at a fitted model.
The broom function <code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code> is used to augment
<code>data</code> with model diagnostics and augment
<code>newdata</code> with predictions. Several advanced features are
available to accommodate fixed covariance parameter values, random
effects, partition factors, anisotropy, simulated data, big data
approximations, and random forests for model fitting and prediction.</p>
<p>We appreciate feedback from users regarding <code>spmodel</code>. To
learn more about how to provide feedback or contribute to
<code>spmodel</code>, please visit our GitHub repository at <a href="https://github.com/USEPA/spmodel" class="external-link">https://github.com/USEPA/spmodel</a>.</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-anselin2010geoda" class="csl-entry">
Anselin, Luc, Ibnu Syabri, and Youngihn Kho. 2010. <span>“GeoDa: An
Introduction to Spatial Data Analysis.”</span> In <em>Handbook of
Applied Spatial Analysis</em>, 73–89. Springer.
</div>
<div id="ref-appelhans2022mapview" class="csl-entry">
Appelhans, Tim, Florian Detsch, Christoph Reudenbach, and Stefan
Woellauer. 2022. <em>Mapview: Interactive Viewing of Spatial Data in
r</em>. <a href="https://CRAN.R-project.org/package=mapview" class="external-link">https://CRAN.R-project.org/package=mapview</a>.
</div>
<div id="ref-bates2015lme4" class="csl-entry">
Bates, Douglas, Martin Mächler, Ben Bolker, and Steve Walker. 2015.
<span>“Fitting Linear Mixed-Effects Models Using <span class="nocase">lme4</span>.”</span> <em>Journal of Statistical
Software</em> 67 (1): 1–48. <a href="https://doi.org/10.18637/jss.v067.i01" class="external-link">https://doi.org/10.18637/jss.v067.i01</a>.
</div>
<div id="ref-box1964analysis" class="csl-entry">
Box, George EP, and David R Cox. 1964. <span>“An Analysis of
Transformations.”</span> <em>Journal of the Royal Statistical Society:
Series B (Methodological)</em> 26 (2): 211–43.
</div>
<div id="ref-cook1982residuals" class="csl-entry">
Cook, R Dennis, and Sanford Weisberg. 1982. <em>Residuals and Influence
in Regression</em>. New York: Chapman; Hall.
</div>
<div id="ref-cressie1985fitting" class="csl-entry">
Cressie, Noel. 1985. <span>“Fitting Variogram Models by Weighted Least
Squares.”</span> <em>Journal of the International Association for
Mathematical Geology</em> 17 (5): 563–86.
</div>
<div id="ref-cressie1993statistics" class="csl-entry">
———. 1993. <em>Statistics for Spatial Data</em>. John Wiley &amp; Sons.
</div>
<div id="ref-curriero1999composite" class="csl-entry">
Curriero, Frank C, and Subhash Lele. 1999. <span>“A Composite Likelihood
Approach to Semivariogram Estimation.”</span> <em>Journal of
Agricultural, Biological, and Environmental Statistics</em>, 9–28.
</div>
<div id="ref-fox2020comparing" class="csl-entry">
Fox, Eric W, Jay M Ver Hoef, and Anthony R Olsen. 2020. <span>“Comparing
Spatial Regression to Random Forests for Large Environmental Data
Sets.”</span> <em>PloS One</em> 15 (3): e0229509.
</div>
<div id="ref-harville1977maximum" class="csl-entry">
Harville, David A. 1977. <span>“Maximum Likelihood Approaches to
Variance Component Estimation and to Related Problems.”</span>
<em>Journal of the American Statistical Association</em> 72 (358):
320–38.
</div>
<div id="ref-hastie2009elements" class="csl-entry">
Hastie, Trevor, Robert Tibshirani, Jerome H Friedman, and Jerome H
Friedman. 2009. <em>The Elements of Statistical Learning: Data Mining,
Inference, and Prediction</em>. Vol. 2. Springer.
</div>
<div id="ref-macqueen1967classification" class="csl-entry">
MacQueen, J. 1967. <span>“Classification and Analysis of Multivariate
Observations.”</span> In <em>5th Berkeley Symp. Math. Statist.
Probability</em>, 281–97. University of California Los Angeles LA USA.
</div>
<div id="ref-montgomery2021introduction" class="csl-entry">
Montgomery, Douglas C, Elizabeth A Peck, and G Geoffrey Vining. 2021.
<em>Introduction to Linear Regression Analysis</em>. John Wiley &amp;
Sons.
</div>
<div id="ref-myers2012generalized" class="csl-entry">
Myers, Raymond H, Douglas C Montgomery, G Geoffrey Vining, and Timothy J
Robinson. 2012. <em>Generalized Linear Models: With Applications in
Engineering and the Sciences</em>. John Wiley &amp; Sons.
</div>
<div id="ref-patterson1971recovery" class="csl-entry">
Patterson, Desmond, and Robin Thompson. 1971. <span>“Recovery of
Inter-Block Information When Block Sizes Are Unequal.”</span>
<em>Biometrika</em> 58 (3): 545–54.
</div>
<div id="ref-pebesma2018sf" class="csl-entry">
Pebesma, Edzer. 2018. <span>“<span class="nocase">Simple Features for R:
Standardized Support for Spatial Vector Data</span>.”</span>
<em><span>The R Journal</span></em> 10 (1): 439–46. <a href="https://doi.org/10.32614/RJ-2018-009" class="external-link">https://doi.org/10.32614/RJ-2018-009</a>.
</div>
<div id="ref-pinheiro2006mixed" class="csl-entry">
Pinheiro, José, and Douglas Bates. 2006. <em>Mixed-Effects Models in s
and s-PLUS</em>. Springer science &amp; business media.
</div>
<div id="ref-robinson2021broom" class="csl-entry">
Robinson, David, Alex Hayes, and Simon Couch. 2021. <em><span class="nocase">broom</span>: Convert Statistical Objects into Tidy
Tibbles</em>. <a href="https://CRAN.R-project.org/package=broom" class="external-link">https://CRAN.R-project.org/package=broom</a>.
</div>
<div id="ref-tobler1970computer" class="csl-entry">
Tobler, Waldo R. 1970. <span>“A Computer Movie Simulating Urban Growth
in the Detroit Region.”</span> <em>Economic Geography</em> 46 (sup1):
234–40.
</div>
<div id="ref-ver2023marginal" class="csl-entry">
Ver Hoef, Jay M, Eryn Blagg, Michael Dumelle, Philip M Dixon, Dale L
Zimmerman, and Paul Conn. 2023. <span>“Marginal Inference for
Hierarchical Generalized Linear Mixed Models with Patterned Covariance
Matrices Using the Laplace Approximation.”</span> <em>arXiv Preprint
arXiv:2305.02978</em>.
</div>
<div id="ref-ver2023indexing" class="csl-entry">
Ver Hoef, Jay M, Michael Dumelle, Matt Higham, Erin E Peterson, and
Daniel J Isaak. 2023. <span>“Indexing and Partitioning the Spatial
Linear Model for Large Data Sets.”</span> <em>arXiv Preprint
arXiv:2305.07811</em>.
</div>
<div id="ref-ver2018spatial" class="csl-entry">
Ver Hoef, Jay M, Erin E Peterson, Mevin B Hooten, Ephraim M Hanks, and
Marie-Josèe Fortin. 2018. <span>“Spatial Autoregressive Models for
Statistical Inference from Ecological Data.”</span> <em>Ecological
Monographs</em> 88 (1): 36–59.
</div>
<div id="ref-wickham2016ggplot2" class="csl-entry">
Wickham, Hadley. 2016. <em><span class="nocase">ggplot2</span>: Elegant
Graphics for Data Analysis</em>. Springer-Verlag New York. <a href="https://ggplot2.tidyverse.org" class="external-link">https://ggplot2.tidyverse.org</a>.
</div>
<div id="ref-wolfinger1994computing" class="csl-entry">
Wolfinger, Russ, Randy Tobias, and John Sall. 1994. <span>“Computing
Gaussian Likelihoods and Their Derivatives for General Linear Mixed
Models.”</span> <em>SIAM Journal on Scientific Computing</em> 15 (6):
1294–1310.
</div>
</div>
<p></p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="appendices">Appendices<a class="anchor" aria-label="anchor" href="#appendices"></a>
</h2>
<div class="section level3">
<h3 id="app:caribou">An Additional Example Using <code>caribou</code><a class="anchor" aria-label="anchor" href="#app:caribou"></a>
</h3>
<p>The purpose of this example is to show more applications of the
<code><a href="../reference/splm.html">splm()</a></code> and <code><a href="../reference/spautor.html">spautor()</a></code> functions when the data
are not an <code>sf</code> object, as well as to show a few other
functions in <code>spmodel</code>. The <code>caribou</code> data are are
designed experiment with two treatments observed on an equally spaced
grid and can be analyzed as point-referenced or areal data. We view the
first few rows of <code>caribou</code> by running</p>
<div class="sourceCode" id="cb135"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">caribou</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 30 × 5</span></span></span>
<span><span class="co">#&gt;    water tarp      z     x     y</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Y     clear  2.42     1     6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Y     shade  2.44     2     6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Y     none   1.81     3     6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> N     clear  1.97     4     6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> N     shade  2.38     5     6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Y     none   2.22     1     5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> N     clear  2.10     2     5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Y     clear  1.80     3     5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Y     shade  1.96     4     5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Y     none   2.10     5     5</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 20 more rows</span></span></span></code></pre>
<p>First we analyze <code>caribou</code> as point-referenced data.
Because <code>caribou</code> is not an <code>sf</code> object, we must
provide the columns in <code>caribou</code> that represent the
x-coordinates and y-coordinates. We fit a spatial linear model
regressing nitrogen percentage (<code>z</code>) on water presence
(<code>water</code>) and tarp cover (<code>tarp</code>) by running</p>
<div class="sourceCode" id="cb137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cariboumod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/splm.html">splm</a></span><span class="op">(</span><span class="va">z</span> <span class="op">~</span> <span class="va">water</span> <span class="op">+</span> <span class="va">tarp</span>, data <span class="op">=</span> <span class="va">caribou</span>,</span>
<span>                   spcov_type <span class="op">=</span> <span class="st">"exponential"</span>, xcoord <span class="op">=</span> <span class="va">x</span>, ycoord <span class="op">=</span> <span class="va">y</span><span class="op">)</span></span></code></pre></div>
<p>An analysis of variance can be conducted to assess the overall impact
of the <code>tarp</code> variable, which has three levels (clear, shade,
and none), and the <code>water</code> variable, which has two levels
(water and no water). We perform an analysis of variance and tidy the
results by running</p>
<div class="sourceCode" id="cb138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/anova.html" class="external-link">anova</a></span><span class="op">(</span><span class="va">cariboumod</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 4</span></span></span>
<span><span class="co">#&gt;   effects        df statistic  p.value</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> (Intercept)     1     43.5  4.33<span style="color: #949494;">e</span><span style="color: #BB0000;">-11</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> water           1      1.66 1.98<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> tarp            2     15.4  4.51<span style="color: #949494;">e</span><span style="color: #BB0000;">- 4</span></span></span></code></pre>
<p>There is significant evidence that at least one tarp cover impacts
nitrogen. Note that, like in <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>, these p-values are
associated with an asymptotic hypothesis test (here, an asymptotic
Chi-squared test).</p>
<p>Next we analyze <code>caribou</code> as areal data. Because
<code>caribou</code> is not an <code>sf</code> object, we must create a
weights matrix. We define two observations as neighbors if they are
adjacent (directly east, west, north, or south) to one another. Two
observations in <code>caribou</code> are adjacent if the distance
between them equals one (recall that observations are not neighbors with
themselves):</p>
<div class="sourceCode" id="cb140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">caribou</span><span class="op">$</span><span class="va">x</span>, <span class="va">caribou</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="va">dists</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">dist</a></span><span class="op">(</span><span class="va">coords</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">W</span> <span class="op">&lt;-</span> <span class="va">dists</span> <span class="op">==</span> <span class="fl">1</span></span></code></pre></div>
<p>Currently, <code>W</code> is a logical matrix with <code>TRUE</code>s
and <code>FALSE</code>s. We coerce it to a numeric matrix by running</p>
<div class="sourceCode" id="cb141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">W</span> <span class="op">&lt;-</span> <span class="va">W</span> <span class="op">*</span> <span class="fl">1</span></span></code></pre></div>
<p>The <span class="math inline">\(ij\)</span>th value in <code>W</code>
is <code>1</code> if the observation in the <span class="math inline">\(i\)</span>th row is neighbors with the observation
in the <span class="math inline">\(j\)</span>th row and <code>0</code>
otherwise. We fit a spatial autoregressive model regressing the nitrogen
percentage (<code>z</code>) on water presence (<code>water</code>) and
tarp cover (<code>tarp</code>) by running</p>
<div class="sourceCode" id="cb142"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cariboumod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spautor.html">spautor</a></span><span class="op">(</span><span class="va">z</span> <span class="op">~</span> <span class="va">water</span> <span class="op">+</span> <span class="va">tarp</span>, data <span class="op">=</span> <span class="va">caribou</span>,</span>
<span>                      spcov_type <span class="op">=</span> <span class="st">"car"</span>, W <span class="op">=</span> <span class="va">W</span><span class="op">)</span></span></code></pre></div>
<p>We perform an analysis of variance and tidy the results by
running</p>
<div class="sourceCode" id="cb143"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/anova.html" class="external-link">anova</a></span><span class="op">(</span><span class="va">cariboumod</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 4</span></span></span>
<span><span class="co">#&gt;   effects        df statistic   p.value</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> (Intercept)     1    714.   2.36<span style="color: #949494;">e</span><span style="color: #BB0000;">-157</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> water           1      1.82 1.77<span style="color: #949494;">e</span><span style="color: #BB0000;">-  1</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> tarp            2     15.1  5.17<span style="color: #949494;">e</span><span style="color: #BB0000;">-  4</span></span></span></code></pre>
<p>There is significant evidence that at least one tarp cover impacts
nitrogen. Note that, like in <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>, these p-values are
associated with an asymptotic hypothesis test (here, an asymptotic
Chi-squared test).</p>
</div>
<div class="section level3">
<h3 id="app:rand">Random Effect Syntax<a class="anchor" aria-label="anchor" href="#app:rand"></a>
</h3>
<p>A couple of common ways to specify random effects in the
<code>random</code> argument to <code><a href="../reference/splm.html">splm()</a></code> or
<code><a href="../reference/spautor.html">spautor()</a></code> include:</p>
<ul>
<li>
<code>~ (1 | group)</code> : Random intercepts for each level of
<code>group</code>. <code>~ group</code> is shorthand for
<code>~ (1 | group)</code>.</li>
<li>
<code>~ (var | group)</code>: Random intercepts for each level of
<code>group</code> and random slopes that depend on the variable
<code>var</code> for each level of <code>group</code>.</li>
</ul>
<p>Some additional syntax for more complicated random effects structures
include:</p>
<ul>
<li>
<code>~ (var - 1 | group)</code>: Random slopes (without intercepts)
that depend on the variable <code>var</code> for each level of
<code>group</code>.</li>
<li>
<code>~ (1 | group:subgroup)</code>: Random intercepts for each
combination of levels in <code>group</code> and levels in
<code>subgroup</code>. <code>~ group:subgroup</code> is shorthand for
<code>~ (1 | group:subgroup)</code>.</li>
<li>
<code>~ (var | group:subgroup)</code>: Random intercepts for each
combination of levels in <code>group</code> and levels in
<code>subgroup</code> and random slopes that depend on the variable
<code>var</code> for each combination of levels in <code>group</code>
and levels in <code>subgroup</code>.</li>
<li>
<code>~ (var - 1 | group:subgroup)</code>: Random slopes (without
intercepts) that depend on the variable <code>var</code> for each
combination of levels in <code>group</code> and levels in
<code>subgroup</code>.</li>
<li>
<code>~ (1 | group/subgroup)</code>: Shorthand for
<code>~ (1 | group) + (1 | group:subgroup)</code>. Commonly, the
<code>group/subgroup</code> notation implies <code>subgroup</code> is
nested within <code>group</code>.</li>
<li>
<code>~ (var | group/subgroup)</code>: Shorthand for
<code>~ (var | group) + (var | group:subgroup)</code>. Commonly, the
<code>group/subgroup</code> notation implies <code>subgroup</code> is
nested within <code>group</code>.</li>
<li>
<code>~ (var - 1 | group/subgroup)</code>: Shorthand for
<code>~ (var - 1 | group) + (var - 1 | group:subgroup)</code>. Commonly,
the <code>group/subgroup</code> notation implies <code>subgroup</code>
is nested within <code>group</code>.</li>
</ul>
<p>Distinct random effects terms are separated in <code>random</code> by
<code>+</code>. Each term must be wrapped in parentheses. For example,
to incorporate random intercepts for <code>group</code> and
<code>subgroup</code>, <code>random</code> looks like
<code>~ (1 | group) + (1 | subgroup)</code>. For random intercepts,
recall that <code>~ group</code> is shorthand for
<code>~ (1 | group)</code>. Thus, an equivalent representation of
<code>~ (1 | group) + (1 | subgroup)</code> is
<code>~ group + subgroup</code>. Note that for both random intercepts
and random slopes, the variable on the right-hand side of <code>|</code>
(i.e., <code>group</code>, <code>subgroup</code>,
<code>group:subgroup</code>) must be a factor (or character)
variable.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Michael Dumelle, Matt Higham, Jay M. Ver Hoef.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
