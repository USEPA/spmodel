<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Block Prediction (i.e., Block Kriging) in spmodel • spmodel</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Block Prediction (i.e., Block Kriging) in spmodel">
<meta property="og:description" content="spmodel">
<meta property="og:image" content="https://usepa.github.io/spmodel/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">spmodel</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.11.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction.html">An Introduction to spmodel</a>
    </li>
    <li>
      <a href="../articles/guide.html">A Detailed Guide to spmodel</a>
    </li>
    <li>
      <a href="../articles/SPGLMs.html">Spatial Generalized Linear Models in spmodel</a>
    </li>
    <li>
      <a href="../articles/emmeans.html">Using emmeans to Estimate Marginal Means of spmodel Objects</a>
    </li>
    <li>
      <a href="../articles/block.html">Block Prediction (i.e., Block Kriging) in spmodel</a>
    </li>
    <li>
      <a href="../articles/technical.html">Technical Details</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/USEPA/spmodel/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Block Prediction (i.e., Block Kriging) in
spmodel</h1>
                        <h4 data-toc-skip class="author">Michael
Dumelle, Matt Higham, and Jay M. Ver Hoef</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/USEPA/spmodel/blob/HEAD/vignettes/articles/block.Rmd" class="external-link"><code>vignettes/articles/block.Rmd</code></a></small>
      <div class="hidden name"><code>block.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="sec:introduction">Introduction<a class="anchor" aria-label="anchor" href="#sec:introduction"></a>
</h2>
<p><code>spmodel</code> is a package used to fit, summarize, and predict
for a variety of spatial statistical models. This vignette explores
tools for predicting the average value of a response variable in a
particular geographic region, an approach known as Block Prediction
(i.e., Block Kriging) <span class="citation">(Cressie 1993; Ver Hoef
2008)</span>. Before proceeding, we load <code>spmodel</code>,
<code>sf</code>, and <code>ggplot2</code> by running</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://usepa.github.io/spmodel/">spmodel</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>If using <code>spmodel</code> in a formal publication or report,
please cite it. Citing <code>spmodel</code> lets us devote more
resources to the package in the future. We view the <code>spmodel</code>
citation by running</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/citation.html" class="external-link">citation</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"spmodel"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; To cite spmodel in publications use:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Dumelle M, Higham M, Ver Hoef JM (2023). spmodel: Spatial statistical</span></span>
<span><span class="co">#&gt;   modeling and prediction in R. PLOS ONE 18(3): e0282524.</span></span>
<span><span class="co">#&gt;   https://doi.org/10.1371/journal.pone.0282524</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A BibTeX entry for LaTeX users is</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   @Article{,</span></span>
<span><span class="co">#&gt;     title = {{spmodel}: Spatial statistical modeling and prediction in {R}},</span></span>
<span><span class="co">#&gt;     author = {Michael Dumelle and Matt Higham and Jay M. {Ver Hoef}},</span></span>
<span><span class="co">#&gt;     journal = {PLOS ONE},</span></span>
<span><span class="co">#&gt;     year = {2023},</span></span>
<span><span class="co">#&gt;     volume = {18},</span></span>
<span><span class="co">#&gt;     number = {3},</span></span>
<span><span class="co">#&gt;     pages = {1--32},</span></span>
<span><span class="co">#&gt;     doi = {10.1371/journal.pone.0282524},</span></span>
<span><span class="co">#&gt;     url = {https://doi.org/10.1371/journal.pone.0282524},</span></span>
<span><span class="co">#&gt;   }</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="block-prediction-i-e--block-kriging-in-spmodel">Block Prediction (i.e., Block Kriging) in <code>spmodel</code><a class="anchor" aria-label="anchor" href="#block-prediction-i-e--block-kriging-in-spmodel"></a>
</h2>
<p>The <code>sulfate</code> data is an <code>sf</code> object that
contains sulfate measurements in the conterminous United States (CONUS).
We first visualize the distribution of the sulfate data by running</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sulfate</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">sulfate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_gray</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span></span></code></pre></div>
<p><img src="block_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>In the “Detailed Guide” vignette, we describe how to fit a spatial
linear model to the sulfate data and use it to predict sulfate
concentrations at the geographic locations in
<code>sulfate_preds</code>. But what if we want to predict the average
sulfate concentration in the entire CONUS? Or what if we want to predict
the average sulfate concentration in a single state like Colorado? Or a
region like the Four Corners region of CONUS? We can answer these
questions using Block Prediction (i.e., Block Kriging).</p>
<p>First, we fit a spatial linear model for sulfate using an
intercept-only model with an exponential spatial covariance function by
running</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sulfmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/splm.html">splm</a></span><span class="op">(</span><span class="va">sulfate</span> <span class="op">~</span> <span class="fl">1</span>, <span class="va">sulfate</span>, spcov_type <span class="op">=</span> <span class="st">"exponential"</span><span class="op">)</span></span></code></pre></div>
<p>We can use this model to perform Block Prediction in any subregion of
CONUS. Consider the four corners region of CONUS, which is composed of
four states: Arizona (AZ), Colorado (CO), New Mexico (NM), and Utah
(UT). <code>fc_borders</code> is a simple features object with polygonal
geometry that contains the boundaries of these four states. We can
visualize the states in this region by running</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">fc_borders</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">STUSPS</span>, label <span class="op">=</span> <span class="va">STUSPS</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf_text</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="block_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>We subset the sulfate data to the observations from the Four Corners
region so that we can zoom in on their values. We implement a slight
jitter (random perturbation) of the coordinates to avoid overplotting
points that are very close to one another. Moreover, we use a different
color scale than for the full <code>sulfate</code> data so we can better
distinguish among the sulfate concentrations in the region:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sulfate_fc</span> <span class="op">&lt;-</span> <span class="va">sulfate</span><span class="op">[</span><span class="va">fc_borders</span>, <span class="op">]</span></span>
<span><span class="va">sulfate_fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_jitter.html" class="external-link">st_jitter</a></span><span class="op">(</span><span class="va">sulfate_fc</span>, factor <span class="op">=</span> <span class="fl">0.04</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">fc_borders</span>, fill <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sulfate_fc</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">sulfate</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"B"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="block_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>The sulfate concentrations in the western part of the Four Corners
region (UT, AZ) appear lower than in the eastern part (CO, NM).</p>
<p>Recall that our goal is to predict the mean sulfate concentration in
the entire region. Block Prediction works (in practice) by first
generating a dense grid of prediction locations that cover the entire
geographic region of interest (here, the Four Corners with boundaries
given in <code>fc_borders</code>). We create this grid and turn the
dense grid (of 5,000 points) into an <code>sf</code> object by
running:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid_size</span> <span class="op">&lt;-</span> <span class="fl">5000</span></span>
<span><span class="va">fc_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html" class="external-link">st_sample</a></span><span class="op">(</span><span class="va">fc_borders</span>, <span class="va">grid_size</span>, type <span class="op">=</span> <span class="st">"hexagonal"</span><span class="op">)</span></span>
<span><span class="va">fc_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">fc_grid</span><span class="op">)</span></span></code></pre></div>
<p>Depending on the size of the spatial domain, consider increasing or
decreasing the grid size. The larger the grid size, the more accurate
the Block Prediction, though the returns diminish rapidly and add
additional computational burden.</p>
<p>We visualize the spatial locations (small, black circles) on the grid
with the observed sulfate concentrations overlain:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">fc_borders</span>, fill <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">fc_grid</span>, size <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sulfate_fc</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">sulfate</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"B"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="block_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>Intuitively, Block Prediction works by making point predictions at
each point in the dense grid and then combining each prediction in a way
that respects the uncertainties associated with the fitted spatial
model. We obtain predictions at each point in the dense grid using the
<code>sulfmod</code> model that was fit to all of the sulfate data in
the conterminous United States by running</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fc_grid</span><span class="op">$</span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">sulfmod</span>, newdata <span class="op">=</span> <span class="va">fc_grid</span><span class="op">)</span></span></code></pre></div>
<p>We visualize these point predictions by running</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">fc_borders</span>, fill <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">fc_grid</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">preds</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sulfate_fc</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">sulfate</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"B"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="block_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>We can combine the point predictions via Block Prediction by adding a
<code>block = TRUE</code> argument to <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">sulfmod</span>, newdata <span class="op">=</span> <span class="va">fc_grid</span>, block <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 3.487391</span></span></code></pre>
<p>Just like with <code><a href="../reference/predict.spmodel.html">predict.splm()</a></code>, we can obtain appropriate
prediction uncertainty using the <code>interval</code> argument:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">sulfmod</span>, newdata <span class="op">=</span> <span class="va">fc_grid</span>, block <span class="op">=</span> <span class="cn">TRUE</span>, interval <span class="op">=</span> <span class="st">"prediction"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;        fit      lwr      upr</span></span>
<span><span class="co">#&gt; 1 3.487391 2.062777 4.912005</span></span></code></pre>
<p>Now suppose that we wanted to predict average sulfate concentrations
in Colorado. First, we subset the Four Corners region to Colorado:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">co_borders</span> <span class="op">&lt;-</span> <span class="va">fc_borders</span><span class="op">[</span><span class="va">fc_borders</span><span class="op">$</span><span class="va">STUSPS</span> <span class="op">==</span> <span class="st">"CO"</span>, <span class="op">]</span></span></code></pre></div>
<p>Then, we subset the dense grid to Colordao:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">co_grid</span> <span class="op">&lt;-</span> <span class="va">fc_grid</span><span class="op">[</span><span class="va">co_borders</span>, <span class="op">]</span></span></code></pre></div>
<p>Finally, we use Block Prediction:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">sulfmod</span>, <span class="va">co_grid</span>, block <span class="op">=</span> <span class="cn">TRUE</span>, interval <span class="op">=</span> <span class="st">"prediction"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;        fit      lwr      upr</span></span>
<span><span class="co">#&gt; 1 3.954228 2.204428 5.704028</span></span></code></pre>
<p>Alternatively, one could create a new grid for Colordao rather than
subsetting the Four Corners grid.</p>
<p>We write a helper function that returns the Block Prediction mean
sulfate concentration for each of the four states (by subsetting the
original grid):</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">return_state_mean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">state_borders</span> <span class="op">&lt;-</span> <span class="va">fc_borders</span><span class="op">[</span><span class="va">fc_borders</span><span class="op">$</span><span class="va">STUSPS</span> <span class="op">==</span> <span class="va">state</span>, <span class="op">]</span></span>
<span>  <span class="va">state_grid</span> <span class="op">&lt;-</span> <span class="va">fc_grid</span><span class="op">[</span><span class="va">state_borders</span>, <span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">sulfmod</span>, <span class="va">state_grid</span>, block <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">fc_borders</span><span class="op">$</span><span class="va">mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">fc_borders</span><span class="op">$</span><span class="va">STUSPS</span>, <span class="va">return_state_mean</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can visualize each Block Prediction of mean sulfate
concentration:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">fc_borders</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"B"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="block_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="some-details">Some Details<a class="anchor" aria-label="anchor" href="#some-details"></a>
</h2>
<p>A few details:</p>
<ul>
<li><p>If the spatial model has explanatory variables, each element in
the dense Block Prediction grid must have values of those explanatory
variables. One way to accomplish this, for example, is to leverage a
raster whose layers contain relevant explanatory variables.</p></li>
<li><p>There is a nuanced difference between Block Prediction and the
fixed effect coefficients estimated by the model. Block Prediction
predicts the realized mean, while the fixed effect coefficients are
estimates of the underlying process mean. For more, see <span class="citation">Dumelle et al. (2022)</span>.</p></li>
<li><p>Block Prediction is only available for point-referenced spatial
linear models (i.e., models fit via <code><a href="../reference/splm.html">splm()</a></code>). Block
Prediction is not available for areal data sets (e.g.,
<code><a href="../reference/spgautor.html">spgautor()</a></code>) or spatial generalized linear models (e.g.,
<code><a href="../reference/spglm.html">spglm()</a></code>, <code><a href="../reference/spgautor.html">spgautor()</a></code>). Like
<code><a href="../reference/predict.spmodel.html">predict.splm()</a></code>, <code>predict.splm(block = TRUE)</code> has
a <code>local</code> argument for large data sets. See
<code>?predict.splm()</code> for more.</p></li>
</ul>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-cressie1993statistics" class="csl-entry">
Cressie, Noel. 1993. <em>Statistics for Spatial Data (Revised
Edition)</em>. Wiley: Hoboken, NJ. <a href="https://doi.org/10.1002/9781119115151" class="external-link">https://doi.org/10.1002/9781119115151</a>.
</div>
<div id="ref-dumelle2022comparison" class="csl-entry">
Dumelle, Michael, Matt Higham, Jay M Ver Hoef, Anthony R Olsen, and Lisa
Madsen. 2022. <span>“A Comparison of Design-Based and Model-Based
Approaches for Finite Population Spatial Sampling and Inference.”</span>
<em>Methods in Ecology and Evolution</em> 13 (9): 2018–29.
</div>
<div id="ref-ver2008spatial" class="csl-entry">
Ver Hoef, Jay M. 2008. <span>“Spatial Methods for Plot-Based Sampling of
Wildlife Populations.”</span> <em>Environmental and Ecological
Statistics</em> 15: 3–13.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Michael Dumelle, Matt Higham, Jay M. Ver Hoef.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
